<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Point Roberts Beach Club — Property Intelligence</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />

</head>
<body>

<!-- ======================== SIDEBAR ======================== -->
<div id="sidebar">
  <div id="sidebar-header">
    <h1>&#9875; Point Roberts Beach Club</h1>
    <p>Property Intelligence &#8212; Whatcom County GIS Data</p>
  </div>

  <!-- Tab bar -->
  <div id="tab-bar">
    <button class="tab-btn active" data-tab="map-panel">Map</button>
    <button class="tab-btn" data-tab="planning-panel">Planning</button>
    <button class="tab-btn" data-tab="partnerships-panel">Partners</button>
    <button class="tab-btn" data-tab="presentation-panel">Present</button>
    <button id="copy-link-btn" title="Copy shareable link">&#128279;</button>
  </div>

  <!-- ======= MAP TAB ======= -->
  <div id="map-panel" class="tab-panel active">
    <!-- The Reef card -->
    <div id="reef-card">
      <div class="label">Target Acquisition</div>
      <h2>&#9733; The Reef &#8212; 1334 Gulf Rd</h2>
      <div class="reef-stats" id="reef-card-stats"></div>
    </div>

    <!-- Action buttons -->
    <div class="map-btn-row">
      <button class="map-btn" id="fly-to-reef">Fly to The Reef &rarr;</button>
      <button class="map-btn on" id="strategic-toggle">Hide Strategic</button>
      <button class="map-btn" id="lots-toggle">Lot Lines</button>
    </div>

    <!-- Filters -->
    <div id="filter-section">
      <div class="section-title">Filter by Category</div>
      <div id="filter-pills"></div>
    </div>

    <!-- Property list -->
    <div id="list-section">
      <div id="list-header">
        <span class="section-title">Properties</span>
        <span id="count-badge">&#8212;</span>
      </div>
      <input id="search-box" type="text" placeholder="Search address or owner&#8230;" />
      <div id="property-list"></div>
    </div>
  </div><!-- /map-panel -->

  <!-- ======= PLANNING TAB ======= -->
  <div id="planning-panel" class="tab-panel">
    <div id="planning-scroll">

      <!-- Strategic Properties -->
      <div class="plan-section">
        <h3>Strategic Properties</h3>
        <div id="strategic-list"></div>
      </div>

      <!-- Valuation chart -->
      <div class="plan-section">
        <h3>Assessed Valuations</h3>
        <div class="chart-wrap">
          <div class="chart-title">Assessed value by property ($M)</div>
          <div id="chart-valuation"></div>
        </div>
      </div>

      <!-- Fee floor chart -->
      <div class="plan-section">
        <h3>Membership Fee Floor</h3>
        <div class="chart-wrap">
          <div class="chart-title">Annual dues floor vs. member count</div>
          <div id="chart-fee-floor"></div>
          <div class="chart-note" id="note-fee-floor"></div>
        </div>
      </div>

      <!-- Revenue model -->
      <div class="plan-section">
        <h3>Year 2 Revenue Model</h3>
        <div class="chart-wrap">
          <div class="chart-title">Revenue vs. costs (Year 2 steady state)</div>
          <div id="chart-revenue"></div>
          <div class="chart-note" id="note-revenue"></div>
        </div>
      </div>

      <!-- Financial gates -->
      <div class="plan-section">
        <h3>Financial Gates</h3>
        <table class="plan-table">
          <thead><tr><th>Trigger</th><th>Threshold</th><th>Signal</th></tr></thead>
          <tbody>
            <tr><td>Founding shares sold (pre-close)</td><td class="hi">&#8805; 50 sold</td><td class="go">GO</td></tr>
            <tr><td>Founding shares sold (pre-close)</td><td>30&#8211;49 sold</td><td class="cond">CONDITIONAL</td></tr>
            <tr><td>Founding shares sold (pre-close)</td><td class="hi">&lt; 30 sold</td><td class="no">NO-GO</td></tr>
            <tr><td>Liquor license</td><td class="hi">WSLCB approval confirmed</td><td class="go">GO</td></tr>
            <tr><td>Liquor license</td><td class="hi">Transfer denied</td><td class="no">NO-GO</td></tr>
            <tr><td>Net cash flow (Year 2)</td><td class="hi">&#8805; $150K</td><td class="go">GO</td></tr>
            <tr><td>Net cash flow (Year 2)</td><td class="hi">&lt; $0</td><td class="no">NO-GO</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Membership tiers -->
      <div class="plan-section">
        <h3>Membership Tiers</h3>
        <table class="plan-table">
          <thead><tr><th>Tier</th><th>Share Price</th><th>Annual Dues</th><th>Cap</th></tr></thead>
          <tbody id="tiers-tbody"></tbody>
        </table>
      </div>

      <!-- Open questions -->
      <div class="plan-section">
        <h3>Open Questions</h3>
        <div class="open-q urgent">
          <div class="q-label">Q1 &#8212; URGENT</div>
          <div class="q-text">Corporate structure: LLC vs. member-owned co-op. Book attorney before any offer.</div>
        </div>
        <div class="open-q urgent">
          <div class="q-label">Q2 &#8212; URGENT</div>
          <div class="q-text">WSLCB: Can existing on-premise liquor license transfer to new entity? Confirm before offer.</div>
        </div>
        <div class="open-q">
          <div class="q-label">Q3</div>
          <div class="q-text">Is 1405 Gulf Rd (adjacent liquor store) available? Combined acquisition changes the entry economics.</div>
        </div>
        <div class="open-q">
          <div class="q-label">Q4</div>
          <div class="q-text">Member cap: 250 vs. 300. Higher cap lowers dues but dilutes exclusivity.</div>
        </div>
        <div class="open-q">
          <div class="q-label">Q5</div>
          <div class="q-text">Transferable memberships? Recommend yes with 15% transfer fee &#8212; creates secondary market, raises perceived value.</div>
        </div>
        <div class="open-q">
          <div class="q-label">Q6</div>
          <div class="q-text">Canadian members paying dues in CAD vs USD: pick one currency. USD simplifies books, CAD may soften resistance.</div>
        </div>
      </div>

      <!-- Validation deadline -->
      <div class="plan-section">
        <h3>Validation Timeline</h3>
        <table class="plan-table">
          <thead><tr><th>Milestone</th><th>Deadline</th></tr></thead>
          <tbody>
            <tr><td>LOI / exclusivity</td><td>Week 0</td></tr>
            <tr><td>Attorney review (structure + liquor)</td><td>+ 2 wks</td></tr>
            <tr><td>Founding member soft commitments</td><td>+ 4 wks</td></tr>
            <tr><td>60-member GO / NO-GO gate</td><td>+ 6 wks</td></tr>
            <tr><td>Close + WSLCB transfer filed</td><td>+ 8 wks</td></tr>
          </tbody>
        </table>
      </div>

    </div><!-- /planning-scroll -->
  </div><!-- /planning-panel -->

  <!-- ======= PARTNERSHIPS TAB ======= -->
  <!-- Cards are rendered from STRATEGIC[] by buildPartnershipsPanel(). -->
  <!-- To add a card: set partnerReady: true on the STRATEGIC entry.    -->
  <!-- To remove a card: set partnerReady: false. Never edit HTML here. -->
  <div id="partnerships-panel" class="tab-panel">
    <p class="partner-intro">
      Proposed models only &mdash; none verified or discussed with any party.
      Only properties with confirmed identity appear here.
      To add or remove a card, change <code>partnerReady</code> in the STRATEGIC array.
    </p>
    <div id="partnerships-list"></div>
  </div><!-- /partnerships-panel -->

  <!-- ======= PRESENTATION TAB ======= -->
  <div id="presentation-panel" class="tab-panel">
    <div id="slide-header">
      <div id="slide-title"></div>
      <div id="slide-subtitle"></div>
    </div>
    <div id="slide-viz"></div>
    <div id="slide-nav">
      <button class="slide-nav-btn" id="slide-prev"><span class="nav-arrow">&#8592;</span> Prev</button>
      <span id="slide-counter"></span>
      <div id="slide-dots"></div>
      <button class="slide-nav-btn" id="slide-next">Next <span class="nav-arrow">&#8594;</span></button>
    </div>
  </div><!-- /presentation-panel -->

</div><!-- /sidebar -->

<!-- ======================== MAP ======================== -->
<div id="map"></div>

<!-- Stats overlay -->
<div id="stats-bar" style="display:none"></div>

<!-- Legend overlay -->
<div id="legend">
  <h4>Legend</h4>
  <div id="legend-items"></div>
</div>

<!-- ======================== SCRIPTS ======================== -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script src="model.js"></script>
<script src="strategic.js"></script>
<script src="map.js"></script>
<script src="planning.js"></script>
<script src="slides.js"></script>

<script>
/* ─────────────────────────────────────────────────────────
   Inline wiring — layout, events, data load, URL state.
   No data. No business logic. Functions live in map/planning/slides.js.
───────────────────────────────────────────────────────── */

/* Reef card stats — rendered from STRATEGIC (strategic.js) */
(function() {
  const REEF = STRATEGIC.find(s => s.id === "reef");
  const el = document.getElementById("reef-card-stats");
  if (!el || !REEF) return;
  el.innerHTML = [
    { v: "$" + REEF.asking.toLocaleString(),   k: "Asking Price"   },
    { v: "$" + REEF.assessed.toLocaleString(), k: "Assessed Value" },
    { v: REEF.sqft.toLocaleString() + " sqft", k: "Building Size"  },
    { v: "Built " + REEF.built,                k: "Year Built"     }
  ].map(s => `<div class="reef-stat"><div class="v">${s.v}</div><div class="k">${s.k}</div></div>`).join("");
})();

/* Wire moveend after pushState is defined below */
map_.on("moveend", () => pushState());

/* ─────────────────────────────────────────────────────────
   TAB SWITCHING
───────────────────────────────────────────────────────── */
function switchTab(panelId) {
  document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  document.getElementById(panelId).classList.add("active");
  document.querySelector(`[data-tab="${panelId}"]`).classList.add("active");

  if (panelId === "planning-panel") {
    document.body.classList.remove("presentation-mode");
    setTimeout(() => {
      if (!document.querySelector("#chart-valuation svg")) buildChartValuation();
      if (!document.querySelector("#chart-fee-floor svg")) buildChartFeeFloor();
      if (!document.querySelector("#chart-revenue svg"))   buildChartRevenue();
      initPlanningNotes();
    }, 50);
  } else if (panelId === "partnerships-panel") {
    document.body.classList.remove("presentation-mode");
    buildPartnershipsPanel();
  } else if (panelId === "presentation-panel") {
    document.body.classList.add("presentation-mode");
    if (!presentationReady) initPresentation();
    else goToSlide(currentSlide);
  } else {
    document.body.classList.remove("presentation-mode");
  }
  pushState();
}

document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => switchTab(btn.dataset.tab));
});

/* ─────────────────────────────────────────────────────────
   STRATEGIC TOGGLE
───────────────────────────────────────────────────────── */
document.getElementById("strategic-toggle").addEventListener("click", () => {
  strategicVisible = !strategicVisible;
  const btn = document.getElementById("strategic-toggle");
  if (strategicVisible) {
    btn.textContent = "Hide Strategic";
    btn.classList.add("on");
  } else {
    btn.textContent = "Strategic Layer";
    btn.classList.remove("on");
  }
  addStrategicMarkers();
  pushState();
});

/* ─────────────────────────────────────────────────────────
   FLY TO THE REEF
───────────────────────────────────────────────────────── */
document.getElementById("fly-to-reef").addEventListener("click", () => {
  const rc = resolveCoords(STRATEGIC.find(s => s.id === "reef"));
  if (rc) map.flyTo([rc.lat, rc.lng], 17, { duration: 1.4 });
});

/* ─────────────────────────────────────────────────────────
   LOT LINES TOGGLE
───────────────────────────────────────────────────────── */
document.getElementById("lots-toggle").addEventListener("click", () => {
  lotsVisible = !lotsVisible;
  const btn = document.getElementById("lots-toggle");
  if (lotsVisible) {
    btn.textContent = "Hide Lots";
    btn.classList.add("on");
    if (lotsLayer) lotsLayer.addTo(map);
  } else {
    btn.textContent = "Lot Lines";
    btn.classList.remove("on");
    if (lotsLayer) map.removeLayer(lotsLayer);
  }
  pushState();
});

/* ─────────────────────────────────────────────────────────
   DATA LOAD + RENDER
───────────────────────────────────────────────────────── */
Promise.all([
  fetch("businesses.geojson").then(r => r.json()).catch(() => null),
  fetch("lots.geojson").then(r => r.json()).catch(() => null)
]).then(([bizData, lotsData]) => {
  if (bizData) {
    allFeatures = bizData.features;
    const cats = new Set(allFeatures.map(f => f.properties.category || "Other"));
    activeCategories = new Set(cats);
    buildFilterPills(cats);
    buildLegend(cats);
    renderAll();
    buildStats();
    document.getElementById("stats-bar").style.display = "flex";
  } else {
    document.getElementById("stats-bar").style.display = "none";
  }
  if (lotsData && lotsData.features && lotsData.features.length) {
    buildLotsLayer(lotsData.features);
  }
  buildStrategicList();
  addStrategicMarkers();
  restoreState();
});

/* ─────────────────────────────────────────────────────────
   URL STATE — shareable links via #hash
───────────────────────────────────────────────────────── */
let _suppressHash = false;

function pushState() {
  if (_suppressHash) return;
  const tab = document.querySelector(".tab-panel.active")?.id || "map-panel";
  const p = new URLSearchParams();
  p.set("tab", tab);
  if (tab === "map-panel") {
    const c = map_.getCenter();
    p.set("zoom", map_.getZoom());
    p.set("lat",  c.lat.toFixed(5));
    p.set("lng",  c.lng.toFixed(5));
  } else if (tab === "presentation-panel") {
    p.set("slide", currentSlide);
  }
  if (lotsVisible)       p.set("lots", "1");
  if (!strategicVisible) p.set("strat", "0");
  history.replaceState(null, "", "#" + p.toString());
}

function restoreState() {
  const hash = location.hash.slice(1);
  if (!hash) return;
  const p = new URLSearchParams(hash);
  const tab = p.get("tab") || "map-panel";
  _suppressHash = true;
  switchTab(tab);
  if (tab === "map-panel") {
    const zoom = parseFloat(p.get("zoom"));
    const lat  = parseFloat(p.get("lat"));
    const lng  = parseFloat(p.get("lng"));
    if (!isNaN(zoom) && !isNaN(lat) && !isNaN(lng)) {
      map_.setView([lat, lng], zoom, { animate: false });
    }
  } else if (tab === "presentation-panel") {
    const slide = parseInt(p.get("slide"), 10);
    if (!isNaN(slide) && slide >= 0 && slide < SLIDES.length) goToSlide(slide);
  }
  if (p.get("lots") === "1" && !lotsVisible) {
    lotsVisible = true;
    const btn = document.getElementById("lots-toggle");
    if (btn) { btn.textContent = "Hide Lots"; btn.classList.add("on"); }
    if (lotsLayer) lotsLayer.addTo(map);
  }
  if (p.get("strat") === "0" && strategicVisible) {
    strategicVisible = false;
    const btn = document.getElementById("strategic-toggle");
    if (btn) { btn.textContent = "Strategic Layer"; btn.classList.remove("on"); }
    addStrategicMarkers();
  }
  _suppressHash = false;
  pushState();
}

window.addEventListener("hashchange", restoreState);

/* ─────────────────────────────────────────────────────────
   COPY LINK
───────────────────────────────────────────────────────── */
document.getElementById("copy-link-btn").addEventListener("click", () => {
  pushState();
  navigator.clipboard.writeText(location.href).then(() => {
    const btn = document.getElementById("copy-link-btn");
    btn.classList.add("copied");
    btn.title = "Copied!";
    setTimeout(() => { btn.classList.remove("copied"); btn.title = "Copy shareable link"; }, 2500);
  }).catch(() => {
    const ta = document.createElement("textarea");
    ta.value = location.href; ta.style.position = "fixed"; ta.style.opacity = "0";
    document.body.appendChild(ta); ta.select(); document.execCommand("copy");
    document.body.removeChild(ta);
    const btn = document.getElementById("copy-link-btn");
    btn.classList.add("copied"); btn.title = "Copied!";
    setTimeout(() => { btn.classList.remove("copied"); btn.title = "Copy shareable link"; }, 2500);
  });
});

/* ─────────────────────────────────────────────────────────
   SEARCH
───────────────────────────────────────────────────────── */
document.getElementById("search-box").addEventListener("input", e => {
  searchQuery = e.target.value.trim();
  renderAll();
});
</script>
</body>
</html>
