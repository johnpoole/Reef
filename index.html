<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Point Roberts Beach Club — Property Intelligence</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      display: flex; height: 100vh; height: 100dvh; overflow: hidden;
      background: #0f1923; color: #e8eaed;
    }

    /* ── Sidebar ── */
    #sidebar {
      width: 380px; min-width: 320px;
      display: flex; flex-direction: column;
      background: #141e2a; border-right: 1px solid #263545; overflow: hidden;
    }
    #sidebar-header {
      padding: 14px 18px 10px; background: #0d1621; border-bottom: 1px solid #1e3048;
    }
    #sidebar-header h1 { font-size: 15px; font-weight: 700; color: #f0c040; letter-spacing: .3px; }
    #sidebar-header p  { font-size: 11px; color: #7a9ab5; margin-top: 2px; }

    /* ── Tabs ── */
    #tab-bar {
      display: flex; background: #0d1621; border-bottom: 1px solid #1e3048;
    }
    .tab-btn {
      flex: 1; padding: 9px 0; font-size: 12px; font-weight: 600;
      background: none; border: none; color: #5a7a94; cursor: pointer;
      border-bottom: 2px solid transparent; transition: all .15s;
    }
    .tab-btn.active { color: #f0c040; border-bottom-color: #f0c040; }
    .tab-btn:hover:not(.active) { color: #c0d0e0; }
    #copy-link-btn {
      flex-shrink: 0; padding: 0 12px; background: none; border: none;
      border-left: 1px solid #1e3048; color: #3a5a74;
      font-size: 14px; cursor: pointer; transition: color .15s;
    }
    #copy-link-btn:hover  { color: #7ab5d8; }
    #copy-link-btn.copied { color: #4caf50; }

    /* ── Tab panels ── */
    .tab-panel { display: none; flex: 1; flex-direction: column; overflow: hidden; }
    .tab-panel.active { display: flex; }

    /* ── MAP TAB ── */
    #reef-card {
      margin: 12px 12px 0;
      background: linear-gradient(135deg, #1a2e1a 0%, #162618 100%);
      border: 1.5px solid #3a7d44; border-radius: 10px; padding: 12px 14px;
    }
    #reef-card .label {
      font-size: 10px; letter-spacing: 1.2px; text-transform: uppercase;
      color: #4caf50; margin-bottom: 4px;
    }
    #reef-card h2 { font-size: 14px; font-weight: 700; color: #f0c040; margin-bottom: 8px; }
    .reef-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .reef-stat { background: rgba(255,255,255,.05); border-radius: 6px; padding: 6px 8px; }
    .reef-stat .v { font-size: 13px; font-weight: 700; color: #e8eaed; }
    .reef-stat .k { font-size: 10px; color: #7a9ab5; margin-top: 1px; }
    .map-btn-row { display: flex; gap: 7px; margin: 10px 12px 0; }
    .map-btn {
      flex: 1; padding: 7px 0; border: none; border-radius: 6px;
      font-size: 12px; font-weight: 600; cursor: pointer; transition: background .2s;
    }
    #fly-to-reef  { background: #2e7d32; color: #fff; }
    #fly-to-reef:hover { background: #388e3c; }
    #strategic-toggle { background: #1e3a50; color: #7ab5d8; }
    #strategic-toggle:hover { background: #264a60; }
    #strategic-toggle.on { background: #154060; color: #40b8e8; border: 1px solid #2a7aaa; }

    #filter-section { padding: 10px 12px 4px; }
    #filter-section .section-title { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: #5a7a94; margin-bottom: 6px; }
    #filter-pills { display: flex; flex-wrap: wrap; gap: 5px; }
    .pill {
      padding: 3px 9px; border-radius: 20px; font-size: 11px; cursor: pointer;
      border: 1.5px solid transparent; transition: all .15s; white-space: nowrap;
    }
    .pill.active { opacity: 1; }
    .pill:not(.active) { opacity: .4; filter: grayscale(60%); }
    .pill:hover { opacity: .85; }

    #list-section { flex: 1; overflow: hidden; display: flex; flex-direction: column; padding-top: 4px; }
    #list-header { padding: 4px 12px; display: flex; justify-content: space-between; align-items: center; }
    #list-header .section-title { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: #5a7a94; }
    #count-badge { font-size: 11px; background: #1e3048; color: #7ab5d8; padding: 2px 7px; border-radius: 10px; }
    #search-box {
      margin: 0 12px 6px; padding: 6px 10px;
      background: #1e2f40; border: 1px solid #263a50; border-radius: 6px;
      color: #e8eaed; font-size: 12px; width: calc(100% - 24px);
    }
    #search-box::placeholder { color: #4a6a80; }
    #search-box:focus { outline: none; border-color: #4a8aaa; }

    #property-list {
      flex: 1; overflow-y: auto; padding: 0 6px 8px;
      scrollbar-width: thin; scrollbar-color: #263545 transparent;
    }
    #property-list::-webkit-scrollbar { width: 5px; }
    #property-list::-webkit-scrollbar-thumb { background: #263545; border-radius: 3px; }

    .property-item {
      padding: 8px 10px; border-radius: 7px; cursor: pointer;
      display: flex; align-items: flex-start; gap: 8px;
      margin-bottom: 3px; transition: background .15s;
      border: 1px solid transparent;
    }
    .property-item:hover { background: #1e3048; }
    .property-item.selected { background: #1e3048; border-color: #2e5070; }
    .property-item.is-reef { border-color: #3a7d44; background: rgba(58,125,68,.12); }
    .property-item.is-strategic { border-color: #335566; background: rgba(30,60,80,.15); }
    .dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; margin-top: 3px; }
    .prop-info { flex: 1; min-width: 0; }
    .prop-address { font-size: 12px; font-weight: 600; color: #d0dce8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .prop-owner   { font-size: 10.5px; color: #5a7a94; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .prop-meta    { text-align: right; flex-shrink: 0; }
    .prop-value   { font-size: 11px; font-weight: 600; color: #7ab5d8; }
    .prop-use     { font-size: 10px; color: #4a6a80; }

    /* ── PLANNING TAB ── */
    #planning-panel {
      flex: 1; overflow-y: auto; padding: 14px 14px 20px;
      scrollbar-width: thin; scrollbar-color: #263545 transparent;
    }
    #planning-panel::-webkit-scrollbar { width: 5px; }
    #planning-panel::-webkit-scrollbar-thumb { background: #263545; border-radius: 3px; }

    .plan-section { margin-bottom: 24px; }
    .plan-section h3 {
      font-size: 11px; font-weight: 700; letter-spacing: 1px;
      text-transform: uppercase; color: #5a7a94; margin-bottom: 10px;
      padding-bottom: 5px; border-bottom: 1px solid #1e3048;
    }

    .strategic-item {
      display: flex; align-items: flex-start; gap: 10px;
      padding: 9px 10px; border-radius: 7px; margin-bottom: 5px;
      cursor: pointer; transition: background .15s; border: 1px solid #1e3048;
    }
    .strategic-item:hover { background: #1e3048; }
    .si-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; margin-top: 3px; }
    .si-info { flex: 1; }
    .si-name { font-size: 13px; font-weight: 700; color: #d8e8f8; }
    .si-status { font-size: 10px; font-weight: 600; letter-spacing: .8px; text-transform: uppercase; }
    .si-note { font-size: 10.5px; color: #5a7a94; margin-top: 2px; line-height: 1.5; }
    .si-assessed { font-size: 11px; color: #7ab5d8; font-weight: 600; text-align: right; flex-shrink: 0; }

    .status-target  { color: #4caf50; }
    .status-stalled { color: #e07840; }
    .status-watch   { color: #d4b040; }
    .status-open    { color: #7ab5d8; }

    /* D3 chart containers */
    .chart-wrap {
      background: #0f1923; border-radius: 8px; padding: 12px 14px;
      margin-bottom: 6px; border: 1px solid #1e3048;
    }
    .chart-title { font-size: 11px; color: #7a9ab5; margin-bottom: 8px; font-weight: 600; }
    .chart-note  { font-size: 10px; color: #4a6a80; margin-top: 6px; }

    /* Data table */
    .plan-table { width: 100%; border-collapse: collapse; font-size: 11.5px; }
    .plan-table th {
      text-align: left; padding: 5px 8px; color: #5a7a94;
      border-bottom: 1px solid #1e3048; font-weight: 600;
    }
    .plan-table td { padding: 6px 8px; border-bottom: 1px solid #1a2838; color: #b0c4d8; }
    .plan-table tr:last-child td { border-bottom: none; }
    .plan-table .go  { color: #4caf50; font-weight: 700; }
    .plan-table .no  { color: #e05040; font-weight: 700; }
    .plan-table .cond { color: #d4b040; font-weight: 700; }
    .plan-table .hi  { color: #e8eaed; font-weight: 700; }

    .open-q { padding: 8px 10px; border-radius: 6px; margin-bottom: 5px; background: #0f1923; border: 1px solid #1e3048; }
    .open-q .q-label { font-size: 10px; color: #5a7a94; margin-bottom: 2px; }
    .open-q .q-text  { font-size: 12px; color: #c0d0e0; line-height: 1.5; }
    .open-q.urgent   { border-color: #5a3020; background: rgba(90,30,10,.15); }
    .open-q.urgent .q-label { color: #e07840; }

    /* ── Map pane ── */
    #map { flex: 1; z-index: 1; }

    /* ── Custom popup ── */
    .leaflet-popup-content-wrapper {
      background: #141e2a; color: #e8eaed; border-radius: 10px;
      border: 1.5px solid #263545; box-shadow: 0 8px 24px rgba(0,0,0,.5); padding: 0;
    }
    .leaflet-popup-tip-container { display: none; }
    .leaflet-popup-content { margin: 0; min-width: 240px; }
    .popup-inner { padding: 14px 16px 12px; }
    .popup-use-badge {
      display: inline-block; padding: 2px 8px; border-radius: 12px;
      font-size: 10px; font-weight: 700; letter-spacing: .5px; margin-bottom: 6px;
    }
    .popup-address { font-size: 14px; font-weight: 700; color: #f0f4f8; margin-bottom: 3px; }
    .popup-owner   { font-size: 11px; color: #7a9ab5; margin-bottom: 10px; }
    .popup-stats   { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 10px; }
    .popup-stat    { background: rgba(255,255,255,.05); border-radius: 6px; padding: 6px 8px; }
    .popup-stat .v { font-size: 13px; font-weight: 700; color: #e8eaed; }
    .popup-stat .k { font-size: 10px; color: #5a7a94; }
    .popup-link {
      display: block; text-align: center; padding: 6px; background: #1e3048;
      border-radius: 6px; font-size: 11px; color: #5ab5d8; text-decoration: none;
    }
    .popup-link:hover { background: #263a50; }

    /* ── Strategic popup additions ── */
    .strategic-popup-flag {
      font-size: 10px; text-transform: uppercase; letter-spacing: .8px;
      font-weight: 700; margin-top: 8px; padding: 4px 8px;
      border-radius: 4px; display: inline-block;
    }
    .flag-target  { background: rgba(76,175,80,.15); color: #4caf50; }
    .flag-stalled { background: rgba(224,120,64,.15); color: #e07840; }
    .flag-watch   { background: rgba(212,176,64,.15); color: #d4b040; }
    .flag-open    { background: rgba(122,181,216,.15); color: #7ab5d8; }

    /* ── Legend ── */
    #legend {
      position: absolute; bottom: 24px; right: 12px; z-index: 1000;
      background: rgba(20,30,42,.93); border: 1px solid #263545;
      border-radius: 8px; padding: 10px 12px; min-width: 160px; font-size: 11px;
    }
    #legend h4 { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #5a7a94; margin-bottom: 7px; }
    .legend-item { display: flex; align-items: center; gap: 7px; margin-bottom: 4px; color: #b0c4d8; }
    .legend-dot  { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

    /* ── PRESENTATION TAB ── */
    body.presentation-mode #sidebar { width: 100%; max-width: 100%; }
    body.presentation-mode #map,
    body.presentation-mode #stats-bar,
    body.presentation-mode #legend { display: none !important; }

    #presentation-panel { flex: 1; flex-direction: column; overflow: hidden; }

    #slide-header {
      padding: 18px 28px 14px;
      border-bottom: 1px solid #1e3048;
      flex-shrink: 0;
    }
    #slide-title {
      font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
      color: #f0c040; font-weight: 700; margin-bottom: 5px;
    }
    #slide-subtitle {
      font-size: 20px; font-weight: 700; color: #e8eaed; line-height: 1.25;
    }
    #slide-viz {
      flex: 1; min-height: 0; overflow-y: auto; padding: 20px 28px 12px;
      transition: opacity 0.15s ease;
      scrollbar-width: thin; scrollbar-color: #263545 transparent;
    }
    #slide-viz::-webkit-scrollbar { width: 5px; }
    #slide-viz::-webkit-scrollbar-thumb { background: #263545; border-radius: 3px; }

    #slide-nav {
      height: 68px; display: flex; align-items: center;
      justify-content: space-between; padding: 0 16px; gap: 10px;
      border-top: 2px solid #1e3048; flex-shrink: 0; background: #0d1621;
    }
    .slide-nav-btn {
      font-size: 14px; font-weight: 700; letter-spacing: .5px;
      height: 46px; padding: 0 20px; border-radius: 8px; white-space: nowrap;
      cursor: pointer; display: flex; align-items: center; gap: 8px;
      transition: all .15s; flex-shrink: 0; min-width: 96px; justify-content: center;
      /* default (Prev) */
      background: #1e3048; border: 1.5px solid #3a5a74; color: #7ab5d8;
    }
    .slide-nav-btn:hover:not(:disabled) { background: #263a50; color: #e8eaed; border-color: #7ab5d8; }
    .slide-nav-btn:disabled { opacity: 0.2; cursor: default; }
    /* Next button — always high-contrast amber fill */
    #slide-next {
      background: #f0c040; border: 1.5px solid #f0c040; color: #0d1621;
    }
    #slide-next:hover:not(:disabled) { background: #f8d060; border-color: #f8d060; color: #0d1621; }
    #slide-next:disabled { background: #2a3a28; border-color: #2a3a28; color: #4a6040; opacity: 1; }
    .slide-nav-btn .nav-arrow { font-size: 18px; line-height: 1; }
    #slide-counter { font-size: 12px; color: #5a7a94; min-width: 44px; text-align: center; flex-shrink: 0; }
    #slide-dots { display: flex; gap: 7px; flex: 1; justify-content: center; align-items: center; }
    .slide-dot {
      width: 7px; height: 7px; border-radius: 50%; background: #263545;
      cursor: pointer; transition: all .15s; border: none; padding: 0;
    }
    .slide-dot.active { background: #f0c040; transform: scale(1.5); }
    .slide-dot:hover:not(.active) { background: #4a6a80; }
    @media (max-width: 520px) {
      #slide-nav { padding: 0 10px; gap: 8px; height: 64px; }
      .slide-nav-btn { min-width: 82px; padding: 0 14px; font-size: 13px; height: 44px; }
      #slide-counter { display: none; }
      #slide-header { padding: 14px 16px 10px; }
      #slide-subtitle { font-size: 16px; }
      #slide-viz { padding: 14px 16px 8px; }
    }

    /* slide content components */
    .sstat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-bottom: 14px; }
    .sstat { background: #141e2a; border: 1px solid #1e3048; border-radius: 8px; padding: 14px 16px; }
    .sstat .sv { font-size: 20px; font-weight: 700; color: #e8eaed; }
    .sstat .sk { font-size: 11px; color: #5a7a94; margin-top: 3px; }
    .sstat.s-hi  { border-color: #f0c040; } .sstat.s-hi .sv  { color: #f0c040; }
    .sstat.s-warn{ border-color: #e07840; } .sstat.s-warn .sv{ color: #e07840; }
    .sstat.s-ok  { border-color: #4caf50; } .sstat.s-ok .sv  { color: #4caf50; }

    .schart-wrap { background: #141e2a; border: 1px solid #1e3048; border-radius: 8px; padding: 14px 18px; margin-bottom: 12px; }
    .schart-title { font-size: 11px; color: #5a7a94; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: .6px; }
    .snote { font-size: 12px; color: #4a6a80; margin-top: 8px; line-height: 1.6; }

    .s2col { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
    .s2col-card { background: #141e2a; border: 1px solid #1e3048; border-radius: 8px; padding: 14px 16px; }
    .s2col-card h4 { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: 700; padding-bottom: 6px; border-bottom: 1px solid #1e3048; }
    .s2col-card.dim h4 { color: #4a6a80; } .s2col-card.bright { border-color: #2a5040; } .s2col-card.bright h4 { color: #4caf50; }
    .s2col-row { padding: 5px 0; font-size: 12px; color: #8090a0; border-bottom: 1px solid #1a2838; line-height: 1.45; }
    .s2col-row:last-child { border-bottom: none; }
    .s2col-card.bright .s2col-row { color: #b0c8b0; }

    .shighlight { background: rgba(240,192,64,.07); border: 1px solid rgba(240,192,64,.25); border-radius: 8px; padding: 12px 16px; margin: 10px 0; font-size: 13px; color: #d0a840; line-height: 1.6; }
    .srisk      { background: rgba(224,80,64,.07);  border: 1px solid rgba(224,80,64,.25);  border-radius: 8px; padding: 12px 16px; margin: 10px 0; font-size: 13px; color: #c07060; line-height: 1.6; }
    .sbold { color: #e8eaed; font-weight: 700; }

    .penclave-diagram { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
    .pcl-side { background: #141e2a; border: 1px solid #1e3048; border-radius: 8px; padding: 16px; text-align: center; }
    .pcl-side.us-side { border-color: #3a2818; } .pcl-side.ca-side { border-color: #1a3828; }
    .pcl-big { font-size: 52px; font-weight: 900; line-height: 1; margin: 8px 0; }
    .pcl-side.us-side .pcl-big { color: #e07840; } .pcl-side.ca-side .pcl-big { color: #4caf50; }
    .pcl-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
    .pcl-side.us-side .pcl-label { color: #a06040; } .pcl-side.ca-side .pcl-label { color: #4a9060; }
    .pcl-desc { font-size: 12px; color: #6080a0; line-height: 1.5; margin-top: 6px; }
    .pcl-steps { display: flex; align-items: center; justify-content: center; gap: 4px; flex-wrap: wrap; margin: 8px 0; font-size: 11px; }
    .pcl-node { background: #1e2f40; border: 1px solid #2a4050; border-radius: 4px; padding: 3px 8px; color: #7ab5d8; white-space: nowrap; }
    .pcl-border { background: rgba(224,80,64,.15); border: 1px solid rgba(224,80,64,.4); border-radius: 4px; padding: 3px 8px; color: #e07070; white-space: nowrap; font-weight: 700; }
    .pcl-arrow { color: #3a5060; font-size: 14px; }

    .gono-tbl { width: 100%; border-collapse: collapse; font-size: 12.5px; }
    .gono-tbl th { text-align: left; padding: 7px 14px; color: #5a7a94; border-bottom: 1px solid #1e3048; font-size: 10px; text-transform: uppercase; letter-spacing: .5px; font-weight: 600; }
    .gono-tbl td { padding: 9px 14px; border-bottom: 1px solid #141e2a; vertical-align: top; }
    .gono-tbl tr:last-child td { border-bottom: none; }
    .gono-tbl .cond-col { color: #d0e0f0; } .gono-tbl .thresh-col { color: #7a9ab5; font-size: 12px; }
    .signal-stop { color: #e05040; font-weight: 700; } .signal-warn { color: #d4b040; font-weight: 700; } .signal-pend { color: #7ab5d8; font-weight: 700; }

    /* ── Photo slide ── */
    .sphoto-hero { position: relative; width: 100%; border-radius: 8px; overflow: hidden; margin-bottom: 12px; background: #0d1621; }
    .sphoto-hero-img { width: 100%; max-height: 260px; object-fit: cover; object-position: center 60%; display: block; }
    .sphoto-caption { font-size: 10px; color: #5a7a94; text-transform: uppercase; letter-spacing: .6px; padding: 6px 10px; background: #0d1621; }
    .sphoto-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 14px; }
    .sphoto-grid a { display: block; border-radius: 5px; overflow: hidden; }
    .sphoto-grid img { width: 100%; height: 72px; object-fit: cover; display: block; transition: opacity .2s; }
    .sphoto-grid a:hover img { opacity: .8; }
    .sphoto-links { background: #141e2a; border: 1px solid #1e3048; border-radius: 8px; padding: 14px 16px; }
    .sphoto-links-title { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #5a7a94; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid #1e3048; font-weight: 700; }
    .sphoto-link-row { display: flex; align-items: baseline; gap: 10px; padding: 5px 0; border-bottom: 1px solid #1a2838; }
    .sphoto-link-row:last-child { border-bottom: none; }
    .sphoto-link-num { font-size: 10px; color: #4a6a80; width: 14px; flex-shrink: 0; text-align: right; }
    .sphoto-link { font-size: 12.5px; color: #7ab5d8; text-decoration: none; word-break: break-all; }
    .sphoto-link:hover { color: #b0d8f0; text-decoration: underline; }

    /* ── Stats bar ── */
    #stats-bar {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      z-index: 1000; display: flex; gap: 8px;
    }
    .stat-pill {
      background: rgba(20,30,42,.93); border: 1px solid #263545;
      border-radius: 20px; padding: 5px 12px; font-size: 11px; color: #7ab5d8; white-space: nowrap;
    }
    .stat-pill strong { color: #e8eaed; font-weight: 700; }
  </style>
</head>
<body>

<!-- ======================== SIDEBAR ======================== -->
<div id="sidebar">
  <div id="sidebar-header">
    <h1>&#9875; Point Roberts Beach Club</h1>
    <p>Property Intelligence &#8212; Whatcom County GIS Data</p>
  </div>

  <!-- Tab bar -->
  <div id="tab-bar">
    <button class="tab-btn active" data-tab="map-panel">Map</button>
    <button class="tab-btn" data-tab="planning-panel">Planning</button>
    <button class="tab-btn" data-tab="presentation-panel">Present</button>
    <button id="copy-link-btn" title="Copy shareable link">&#128279;</button>
  </div>

  <!-- ======= MAP TAB ======= -->
  <div id="map-panel" class="tab-panel active">
    <!-- The Reef card -->
    <div id="reef-card">
      <div class="label">Target Acquisition</div>
      <h2>&#9733; The Reef &#8212; 1334 Gulf Rd</h2>
      <div class="reef-stats">
        <div class="reef-stat"><div class="v">$1,375,000</div><div class="k">Asking Price</div></div>
        <div class="reef-stat"><div class="v">$850,965</div><div class="k">Assessed Value</div></div>
        <div class="reef-stat"><div class="v">8,463 sqft</div><div class="k">Building Size</div></div>
        <div class="reef-stat"><div class="v">Built 1959</div><div class="k">Year Built</div></div>
      </div>
    </div>

    <!-- Action buttons -->
    <div class="map-btn-row">
      <button class="map-btn" id="fly-to-reef">Fly to The Reef &rarr;</button>
      <button class="map-btn on" id="strategic-toggle">Hide Strategic</button>
    </div>

    <!-- Filters -->
    <div id="filter-section">
      <div class="section-title">Filter by Category</div>
      <div id="filter-pills"></div>
    </div>

    <!-- Property list -->
    <div id="list-section">
      <div id="list-header">
        <span class="section-title">Properties</span>
        <span id="count-badge">&#8212;</span>
      </div>
      <input id="search-box" type="text" placeholder="Search address or owner&#8230;" />
      <div id="property-list"></div>
    </div>
  </div><!-- /map-panel -->

  <!-- ======= PLANNING TAB ======= -->
  <div id="planning-panel" class="tab-panel">
    <div id="planning-scroll">

      <!-- Strategic Properties -->
      <div class="plan-section">
        <h3>Strategic Properties</h3>
        <div id="strategic-list"></div>
      </div>

      <!-- Valuation chart -->
      <div class="plan-section">
        <h3>Assessed Valuations</h3>
        <div class="chart-wrap">
          <div class="chart-title">Assessed value by property ($M)</div>
          <div id="chart-valuation"></div>
        </div>
      </div>

      <!-- Fee floor chart -->
      <div class="plan-section">
        <h3>Membership Fee Floor</h3>
        <div class="chart-wrap">
          <div class="chart-title">Annual dues floor vs. member count</div>
          <div id="chart-fee-floor"></div>
          <div class="chart-note" id="note-fee-floor"></div>
        </div>
      </div>

      <!-- Revenue model -->
      <div class="plan-section">
        <h3>Year 2 Revenue Model</h3>
        <div class="chart-wrap">
          <div class="chart-title">Revenue vs. costs (Year 2 steady state)</div>
          <div id="chart-revenue"></div>
          <div class="chart-note" id="note-revenue"></div>
        </div>
      </div>

      <!-- Financial gates -->
      <div class="plan-section">
        <h3>Financial Gates</h3>
        <table class="plan-table">
          <thead><tr><th>Trigger</th><th>Threshold</th><th>Signal</th></tr></thead>
          <tbody>
            <tr><td>Founding shares sold (pre-close)</td><td class="hi">&#8805; 50 sold</td><td class="go">GO</td></tr>
            <tr><td>Founding shares sold (pre-close)</td><td>30&#8211;49 sold</td><td class="cond">CONDITIONAL</td></tr>
            <tr><td>Founding shares sold (pre-close)</td><td class="hi">&lt; 30 sold</td><td class="no">NO-GO</td></tr>
            <tr><td>Liquor license</td><td class="hi">WSLCB approval confirmed</td><td class="go">GO</td></tr>
            <tr><td>Liquor license</td><td class="hi">Transfer denied</td><td class="no">NO-GO</td></tr>
            <tr><td>Net cash flow (Year 2)</td><td class="hi">&#8805; $150K</td><td class="go">GO</td></tr>
            <tr><td>Net cash flow (Year 2)</td><td class="hi">&lt; $0</td><td class="no">NO-GO</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Membership tiers -->
      <div class="plan-section">
        <h3>Membership Tiers</h3>
        <table class="plan-table">
          <thead><tr><th>Tier</th><th>Share Price</th><th>Annual Dues</th><th>Cap</th></tr></thead>
          <tbody id="tiers-tbody"></tbody>
        </table>
      </div>

      <!-- Open questions -->
      <div class="plan-section">
        <h3>Open Questions</h3>
        <div class="open-q urgent">
          <div class="q-label">Q1 &#8212; URGENT</div>
          <div class="q-text">Corporate structure: LLC vs. member-owned co-op. Book attorney before any offer.</div>
        </div>
        <div class="open-q urgent">
          <div class="q-label">Q2 &#8212; URGENT</div>
          <div class="q-text">WSLCB: Can existing on-premise liquor license transfer to new entity? Confirm before offer.</div>
        </div>
        <div class="open-q">
          <div class="q-label">Q3</div>
          <div class="q-text">Is 1405 Gulf Rd (adjacent liquor store) available? Combined acquisition changes the entry economics.</div>
        </div>
        <div class="open-q">
          <div class="q-label">Q4</div>
          <div class="q-text">Member cap: 250 vs. 300. Higher cap lowers dues but dilutes exclusivity.</div>
        </div>
        <div class="open-q">
          <div class="q-label">Q5</div>
          <div class="q-text">Transferable memberships? Recommend yes with 15% transfer fee &#8212; creates secondary market, raises perceived value.</div>
        </div>
        <div class="open-q">
          <div class="q-label">Q6</div>
          <div class="q-text">Canadian members paying dues in CAD vs USD: pick one currency. USD simplifies books, CAD may soften resistance.</div>
        </div>
      </div>

      <!-- Validation deadline -->
      <div class="plan-section">
        <h3>Validation Timeline</h3>
        <table class="plan-table">
          <thead><tr><th>Milestone</th><th>Deadline</th></tr></thead>
          <tbody>
            <tr><td>LOI / exclusivity</td><td>Week 0</td></tr>
            <tr><td>Attorney review (structure + liquor)</td><td>+ 2 wks</td></tr>
            <tr><td>Founding member soft commitments</td><td>+ 4 wks</td></tr>
            <tr><td>60-member GO / NO-GO gate</td><td>+ 6 wks</td></tr>
            <tr><td>Close + WSLCB transfer filed</td><td>+ 8 wks</td></tr>
          </tbody>
        </table>
      </div>

    </div><!-- /planning-scroll -->
  </div><!-- /planning-panel -->

  <!-- ======= PRESENTATION TAB ======= -->
  <div id="presentation-panel" class="tab-panel">
    <div id="slide-header">
      <div id="slide-title"></div>
      <div id="slide-subtitle"></div>
    </div>
    <div id="slide-viz"></div>
    <div id="slide-nav">
      <button class="slide-nav-btn" id="slide-prev"><span class="nav-arrow">&#8592;</span> Prev</button>
      <span id="slide-counter"></span>
      <div id="slide-dots"></div>
      <button class="slide-nav-btn" id="slide-next">Next <span class="nav-arrow">&#8594;</span></button>
    </div>
  </div><!-- /presentation-panel -->

</div><!-- /sidebar -->

<!-- ======================== MAP ======================== -->
<div id="map"></div>

<!-- Stats overlay -->
<div id="stats-bar" style="display:none"></div>

<!-- Legend overlay -->
<div id="legend">
  <h4>Legend</h4>
  <div id="legend-items"></div>
</div>

<!-- ======================== SCRIPTS ======================== -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script src="model.js"></script>

<script>
/* ─────────────────────────────────────────────────────────
   STRATEGIC PROPERTIES  (hardcoded planning data)
───────────────────────────────────────────────────────── */
const STRATEGIC = [
  {
    id: "reef", name: "★ The Reef", lat: 48.98453, lng: -123.08337,
    status: "target", assessed: 850965, asking: 1375000,
    sqft: 8463, built: 1959, address: "1334 Gulf Rd",
    note: "Target acquisition. Bar/restaurant + lodging. On-premise liquor license. Asking $1.375M vs $851K assessed = 62% premium. Asking price negotiable.",
    color: "#f0c040"
  },

  {
    id: "liquorstore", name: "Adjacent Liquor Store", lat: 48.98422, lng: -123.07842,
    status: "watch", assessed: 202000, asking: null,
    sqft: null, built: null, address: "1405 Gulf Rd",
    note: "Adjacent parcel. Combined acquisition with The Reef changes entry economics. Check availability.",
    color: "#d4b040"
  },
  {
    id: "marina", name: "Point Roberts Marina", lat: 48.97808, lng: -123.06286,
    status: "open", assessed: 12770000, asking: null,
    sqft: null, built: null, address: "713 Simundson Dr",
    note: "Major amenity. 800-slip marina. Natural partner for membership cross-promotion. Not for sale.",
    color: "#7ab5d8"
  },
  {
    id: "golf", name: "Golf & Country Club", lat: 48.99604, lng: -123.08235,
    status: "open", assessed: 4340000, asking: null,
    sqft: null, built: null, address: "500 Benson Rd",
    note: "Existing members club in PR. Potential cross-membership deal. Operating successfully.",
    color: "#7ab5d8"
  },
  {
    id: "hislop", name: "Hislop Food Operations", lat: 48.98409, lng: -123.08323,
    status: "open", assessed: 1500000, asking: null,
    sqft: null, built: null, address: "1330 Gulf Rd",
    note: "IGA grocery + Subway directly adjacent to The Reef. Hislop family controls key food retail in PR. Monitor for future consolidation opportunity.",
    color: "#7ab5d8"
  }
];

/* ─────────────────────────────────────────────────────────
   CATEGORY COLORS  (for GIS parcels)
───────────────────────────────────────────────────────── */
const CAT_COLORS = {
  "Food & Drink":    "#e05c5c",
  "Lodging":        "#e08c40",
  "Retail":         "#d4b040",
  "Services":       "#7ab5d8",
  "Recreation":     "#4caf50",
  "Marina/Marine":  "#40c8d8",
  "Government":     "#a060d0",
  "Commercial":     "#7a9ab5",
  "Vacant":         "#3a4a5a",
  "Other":          "#5a6a7a"
};

/* ─────────────────────────────────────────────────────────
   STATE
───────────────────────────────────────────────────────── */
let allFeatures = [];
let activeCategories = new Set();
let searchQuery = "";
let strategicVisible = true;
let strategicMarkers = [];
let selectedId = null;
let map, geoLayer;

/* ─────────────────────────────────────────────────────────
   MAP INIT
───────────────────────────────────────────────────────── */
const map_ = L.map("map", { zoomControl: false }).setView([48.982, -123.075], 14);
map = map_;
L.control.zoom({ position: "bottomright" }).addTo(map);
map_.on("moveend", pushState);

L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
  attribution: "&copy; OSM contributors &copy; CARTO",
  maxZoom: 19
}).addTo(map);

/* ─────────────────────────────────────────────────────────
   PLANNING TAB — MODEL-DRIVEN NOTES + TABLES
───────────────────────────────────────────────────────── */
function initPlanningNotes() {
  const M = MODEL;
  const k = n => Math.round(n / 1000);

  const feeNote = document.getElementById("note-fee-floor");
  if (feeNote) feeNote.textContent =
    `Dues floor: automated model, shares fund acquisition (no mortgage). Break-even \u2248 ${M.mAutoBreak} members at avg $${M.avgDues.toLocaleString()} dues. At ${M.totalMembers} members the floor is $${Math.round(M.burdenAuto/M.totalMembers).toLocaleString()}/yr \u2014 actual dues run far above it.`;

  const revNote = document.getElementById("note-revenue");
  if (revNote) revNote.innerHTML =
    `${M.totalMembers} members; tier avg $${(M.avgDues/1000).toFixed(2).replace(/\.?0+$/,"")}K/yr dues ($${k(M.annualDues)}K total). Light F&amp;B + events gross $${k(M.fbGross)}K. No mortgage \u2014 ${M.totalMembers} shares fund the $${(M.shareEquity/1e6).toFixed(3).replace(/\.?0+$/,"")}M acquisition. Net cash flow ~$${k(M.cashFlow)}K/yr.`;

  const tb = document.getElementById("tiers-tbody");
  if (tb) tb.innerHTML = M.tiers.map((t, i) =>
    `<tr><td>${t.name}</td><td${i===0?' class="hi"':''}>$${t.sharePx.toLocaleString()}</td><td${i===0?' class="hi"':''}>$${t.dues.toLocaleString()}${i===0?' locked':''}</td><td>${t.cap}</td></tr>`
  ).join("");
}

/* ─────────────────────────────────────────────────────────
   D3 CHARTS
───────────────────────────────────────────────────────── */
function buildChartValuation() {
  const el = document.getElementById("chart-valuation");
  if (!el) return;
  const W = el.clientWidth || 330, H = 180;
  const margin = { top: 6, right: 60, bottom: 6, left: 130 };
  const w = W - margin.left - margin.right;
  const h = H - margin.top - margin.bottom;

  const data = STRATEGIC
    .filter(d => d.assessed > 0)
    .sort((a, b) => b.assessed - a.assessed);

  const x = d3.scaleLinear().domain([0, d3.max(data, d => d.assessed)]).range([0, w]);
  const y = d3.scaleBand().domain(data.map(d => d.id)).range([0, h]).padding(0.2);

  const svg = d3.select(el).append("svg")
    .attr("width", W).attr("height", H)
    .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  svg.selectAll("rect").data(data).join("rect")
    .attr("y",      d => y(d.id))
    .attr("height", y.bandwidth())
    .attr("x", 0).attr("width", 0)
    .attr("rx", 3)
    .attr("fill", d => d.color)
    .attr("opacity", 0.85)
    .transition().duration(700).delay((d, i) => i * 80)
    .attr("width", d => x(d.assessed));

  svg.selectAll(".label").data(data).join("text")
    .attr("class", "label")
    .attr("y", d => y(d.id) + y.bandwidth() / 2 + 4)
    .attr("x", -6)
    .attr("text-anchor", "end")
    .attr("fill", "#b0c4d8").attr("font-size", "10px")
    .text(d => d.name.replace("★ ", "").substring(0, 16));

  svg.selectAll(".val").data(data).join("text")
    .attr("class", "val")
    .attr("y", d => y(d.id) + y.bandwidth() / 2 + 4)
    .attr("x", d => x(d.assessed) + 5)
    .attr("fill", "#e8eaed").attr("font-size", "10px").attr("font-weight", "bold")
    .text(d => "$" + (d.assessed / 1e6).toFixed(1) + "M");
}

function buildChartFeeFloor() {
  const el = document.getElementById("chart-fee-floor");
  if (!el) return;
  const W = el.clientWidth || 330, H = 160;
  const margin = { top: 10, right: 20, bottom: 30, left: 56 };
  const w = W - margin.left - margin.right;
  const h = H - margin.top - margin.bottom;

  const M = MODEL;
  const burden = M.burdenAuto;
  const members = d3.range(25, M.totalMembers + 1, 5);
  const points = members.map(m => ({ m, dues: burden / m }));

  const x = d3.scaleLinear().domain([25, M.totalMembers]).range([0, w]);
  const y = d3.scaleLinear().domain([0, d3.max(points, d => d.dues) * 1.1]).range([h, 0]);

  const svg = d3.select(el).append("svg")
    .attr("width", W).attr("height", H)
    .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  // Green target band 200-250
  svg.append("rect")
    .attr("x", x(200)).attr("width", x(250) - x(200))
    .attr("y", 0).attr("height", h)
    .attr("fill", "rgba(76,175,80,0.12)");

  svg.append("text").attr("x", x(225)).attr("y", 10)
    .attr("text-anchor", "middle").attr("fill", "#4caf50").attr("font-size", "9px")
    .text("target");

  // X axis
  svg.append("g").attr("transform", `translate(0,${h})`).call(
    d3.axisBottom(x).ticks(5).tickFormat(d => d)
  ).selectAll("text").attr("fill", "#5a7a94").attr("font-size", "10px");
  svg.selectAll(".domain, .tick line").attr("stroke", "#263545");

  // Y axis
  svg.append("g").call(
    d3.axisLeft(y).ticks(4).tickFormat(d => "$" + Math.round(d / 1000) + "K")
  ).selectAll("text").attr("fill", "#5a7a94").attr("font-size", "10px");
  svg.selectAll(".domain, .tick line").attr("stroke", "#263545");

  // Line
  const line = d3.line().x(d => x(d.m)).y(d => y(d.dues)).curve(d3.curveCatmullRom);
  const path = svg.append("path")
    .datum(points).attr("fill", "none")
    .attr("stroke", "#f0c040").attr("stroke-width", 2)
    .attr("d", line);

  // Animate
  const len = path.node().getTotalLength();
  path.attr("stroke-dasharray", len).attr("stroke-dashoffset", len)
    .transition().duration(900).attr("stroke-dashoffset", 0);

  // X label
  svg.append("text").attr("x", w / 2).attr("y", h + 26)
    .attr("text-anchor", "middle").attr("fill", "#5a7a94").attr("font-size", "10px")
    .text("Members");
}

function buildChartRevenue() {
  const el = document.getElementById("chart-revenue");
  if (!el) return;
  const W = el.clientWidth || 330, H = 180;
  const margin = { top: 10, right: 20, bottom: 40, left: 16 };
  const w = W - margin.left - margin.right;
  const h = H - margin.top - margin.bottom;

  const M = MODEL;
  const items = [
    { label: "Dues",      value:  M.annualDues,                                    type: "in"  },
    { label: "F&B",       value:  M.fbLight,                                        type: "in"  },
    { label: "Events",    value:  M.fbEvents,                                       type: "in"  },
    { label: "Labor",     value: -M.laborAutoMid,                                   type: "out" },
    { label: "COGS",      value: -Math.round((M.costs[1].lo+M.costs[1].hi)/2),     type: "out" },
    { label: "Other Ops", value: -M.otherOpsMid,                                   type: "out" },
    { label: "Cash Flow", value:  M.cashFlow,                                       type: "net" }
  ];

  const maxVal = d3.max(items, d => Math.abs(d.value));
  const x = d3.scaleBand().domain(items.map(d => d.label)).range([0, w]).padding(0.25);
  const y = d3.scaleLinear().domain([-maxVal * 1.05, maxVal * 1.05]).range([h, 0]);

  const svg = d3.select(el).append("svg")
    .attr("width", W).attr("height", H)
    .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  // Zero line
  svg.append("line")
    .attr("x1", 0).attr("x2", w)
    .attr("y1", y(0)).attr("y2", y(0))
    .attr("stroke", "#263545").attr("stroke-width", 1);

  svg.selectAll("rect").data(items).join("rect")
    .attr("x",  d => x(d.label))
    .attr("width", x.bandwidth())
    .attr("rx", 3)
    .attr("y",      d => d.value >= 0 ? y(d.value) : y(0))
    .attr("height", d => Math.abs(y(d.value) - y(0)))
    .attr("fill",   d => d.type === "in" ? "#4caf50" : d.type === "out" ? "#e05040" : "#f0c040")
    .attr("opacity", 0)
    .transition().duration(600).delay((d, i) => i * 90)
    .attr("opacity", 0.85);

  svg.selectAll(".bar-label").data(items).join("text")
    .attr("class", "bar-label")
    .attr("x", d => x(d.label) + x.bandwidth() / 2)
    .attr("y", d => d.value >= 0 ? y(d.value) - 3 : y(0) + Math.abs(y(d.value) - y(0)) + 11)
    .attr("text-anchor", "middle")
    .attr("fill", "#7ab5d8").attr("font-size", "9px")
    .text(d => (d.value >= 0 ? "+" : "") + Math.round(d.value / 1000) + "K");

  svg.selectAll(".x-label").data(items).join("text")
    .attr("class", "x-label")
    .attr("x", d => x(d.label) + x.bandwidth() / 2)
    .attr("y", h + 14)
    .attr("text-anchor", "middle")
    .attr("fill", "#5a7a94").attr("font-size", "9px")
    .text(d => d.label);
}

/* ─────────────────────────────────────────────────────────
   STRATEGIC MARKERS
───────────────────────────────────────────────────────── */
function addStrategicMarkers() {
  strategicMarkers.forEach(m => map.removeLayer(m));
  strategicMarkers = [];
  if (!strategicVisible) return;

  STRATEGIC.forEach(s => {
    const isReef = s.id === "reef";
    const marker = L.circleMarker([s.lat, s.lng], {
      radius:      isReef ? 18 : 13,
      fillColor:   s.color,
      color:       isReef ? "#ffffff" : s.color,
      weight:      isReef ? 3 : 1.5,
      opacity:     0.9,
      fillOpacity: isReef ? 0.9 : 0.7
    });

    const statusMap = { target: "Target", stalled: "⚠ Stalled", watch: "Watch", open: "Open" };
    const flagClass = `flag-${s.status}`;
    marker.bindPopup(`
      <div class="popup-inner">
        <div class="popup-address">${s.name}</div>
        <div class="popup-owner">${s.address}</div>
        <div class="popup-stats">
          <div class="popup-stat"><div class="v">${s.assessed ? "$" + (s.assessed/1e6).toFixed(2) + "M" : "—"}</div><div class="k">Assessed</div></div>
          <div class="popup-stat"><div class="v">${s.asking ? "$" + (s.asking/1e6).toFixed(2) + "M" : "—"}</div><div class="k">Asking</div></div>
          <div class="popup-stat"><div class="v">${s.sqft ? s.sqft.toLocaleString() + " sqft" : "—"}</div><div class="k">Size</div></div>
          <div class="popup-stat"><div class="v">${s.built || "—"}</div><div class="k">Built</div></div>
        </div>
        <div class="strategic-popup-flag ${flagClass}">${statusMap[s.status]}</div>
        <div class="popup-owner" style="margin-top:8px;line-height:1.5;">${s.note}</div>
      </div>
    `, { maxWidth: 300 });

    marker.addTo(map);
    strategicMarkers.push(marker);
  });
}

/* ─────────────────────────────────────────────────────────
   PLANNING TAB — Strategic list
───────────────────────────────────────────────────────── */
function buildStrategicList() {
  const el = document.getElementById("strategic-list");
  if (!el) return;
  el.innerHTML = "";
  STRATEGIC.forEach(s => {
    const item = document.createElement("div");
    item.className = "strategic-item";
    const statusLabels = { target: "Target", stalled: "⚠ Stalled", watch: "Watch", open: "Open" };
    item.innerHTML = `
      <div class="si-dot" style="background:${s.color}"></div>
      <div class="si-info">
        <div class="si-name">${s.name}</div>
        <div class="si-status status-${s.status}">${statusLabels[s.status]}</div>
        <div class="si-note">${s.address}</div>
      </div>
      <div class="si-assessed">${s.assessed ? "$" + (s.assessed/1e6).toFixed(1) + "M" : "—"}</div>
    `;
    item.addEventListener("click", () => {
      // Switch to Map tab, fly there, enable strategic layer
      switchTab("map-panel");
      map.flyTo([s.lat, s.lng], 16, { duration: 1 });
      if (!strategicVisible) {
        strategicVisible = true;
        document.getElementById("strategic-toggle").textContent = "Hide Strategic";
        document.getElementById("strategic-toggle").classList.add("on");
        addStrategicMarkers();
      }
      // Open popup
      setTimeout(() => {
        const m = strategicMarkers.find((_, i) => STRATEGIC[i].id === s.id);
        if (m) m.openPopup();
      }, 1100);
    });
    el.appendChild(item);
  });
}

/* ─────────────────────────────────────────────────────────
   TAB SWITCHING
───────────────────────────────────────────────────────── */
function switchTab(panelId) {
  document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  document.getElementById(panelId).classList.add("active");
  document.querySelector(`[data-tab="${panelId}"]`).classList.add("active");

  if (panelId === "planning-panel") {
    document.body.classList.remove("presentation-mode");
    setTimeout(() => {
      if (!document.querySelector("#chart-valuation svg")) buildChartValuation();
      if (!document.querySelector("#chart-fee-floor svg")) buildChartFeeFloor();
      if (!document.querySelector("#chart-revenue svg"))   buildChartRevenue();
      initPlanningNotes();
    }, 50);
  } else if (panelId === "presentation-panel") {
    document.body.classList.add("presentation-mode");
    if (!presentationReady) initPresentation();
    else goToSlide(currentSlide);
  } else {
    document.body.classList.remove("presentation-mode");
  }
  pushState();
}

document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => switchTab(btn.dataset.tab));
});

/* ─────────────────────────────────────────────────────────
   STRATEGIC TOGGLE
───────────────────────────────────────────────────────── */
document.getElementById("strategic-toggle").addEventListener("click", () => {
  strategicVisible = !strategicVisible;
  const btn = document.getElementById("strategic-toggle");
  if (strategicVisible) {
    btn.textContent = "Hide Strategic";
    btn.classList.add("on");
  } else {
    btn.textContent = "Strategic Layer";
    btn.classList.remove("on");
  }
  addStrategicMarkers();
});

/* ─────────────────────────────────────────────────────────
   FLY TO THE REEF
───────────────────────────────────────────────────────── */
document.getElementById("fly-to-reef").addEventListener("click", () => {
  map.flyTo([48.98453, -123.08337], 17, { duration: 1.4 });
});

/* ─────────────────────────────────────────────────────────
   DATA LOAD + RENDER
───────────────────────────────────────────────────────── */
fetch("businesses.geojson")
  .then(r => r.json())
  .then(data => {
    allFeatures = data.features;

    // Collect categories
    const cats = new Set(allFeatures.map(f => f.properties.category || "Other"));
    activeCategories = new Set(cats);

    buildFilterPills(cats);
    buildLegend(cats);
    renderAll();
    buildStats();
    buildStrategicList();     // Populate the planning tab list
    addStrategicMarkers();      // Show strategic layer by default
    document.getElementById("stats-bar").style.display = "flex";
    restoreState();
  })
  .catch(() => {
    // If no GeoJSON, still render planning
    buildStrategicList();
    addStrategicMarkers();
    document.getElementById("stats-bar").style.display = "none";
  });

/* ─────────────────────────────────────────────────────────
   FILTER PILLS
───────────────────────────────────────────────────────── */
function buildFilterPills(cats) {
  const container = document.getElementById("filter-pills");
  container.innerHTML = "";

  // ALL pill
  const allPill = document.createElement("div");
  allPill.className = "pill active";
  allPill.style.background = "#1e3048";
  allPill.style.color = "#e8eaed";
  allPill.style.borderColor = "#2e5070";
  allPill.textContent = "All";
  allPill.addEventListener("click", () => {
    activeCategories = new Set(cats);
    document.querySelectorAll(".pill").forEach(p => p.classList.add("active"));
    renderAll();
  });
  container.appendChild(allPill);

  [...cats].sort().forEach(cat => {
    const color = CAT_COLORS[cat] || CAT_COLORS["Other"];
    const pill = document.createElement("div");
    pill.className = "pill active";
    pill.style.background = color + "22";
    pill.style.borderColor = color;
    pill.style.color = color;
    pill.textContent = cat;
    pill.addEventListener("click", () => {
      if (activeCategories.has(cat)) {
        activeCategories.delete(cat);
        pill.classList.remove("active");
      } else {
        activeCategories.add(cat);
        pill.classList.add("active");
      }
      renderAll();
    });
    container.appendChild(pill);
  });
}

/* ─────────────────────────────────────────────────────────
   LEGEND
───────────────────────────────────────────────────────── */
function buildLegend(cats) {
  const container = document.getElementById("legend-items");
  [...cats].sort().forEach(cat => {
    const color = CAT_COLORS[cat] || CAT_COLORS["Other"];
    const item = document.createElement("div");
    item.className = "legend-item";
    item.innerHTML = `<div class="legend-dot" style="background:${color}"></div><span>${cat}</span>`;
    container.appendChild(item);
  });
}

/* ─────────────────────────────────────────────────────────
   RENDER ALL
───────────────────────────────────────────────────────── */
function renderAll() {
  const q = searchQuery.toLowerCase();
  const filtered = allFeatures.filter(f => {
    const p = f.properties;
    if (!activeCategories.has(p.category || "Other")) return false;
    if (q && !( (p.address||"").toLowerCase().includes(q) || (p.owner||"").toLowerCase().includes(q) )) return false;
    return true;
  });

  document.getElementById("count-badge").textContent = filtered.length + " / " + allFeatures.length;

  // Map layer — skip The Reef from regular markers (strategic layer handles it)
  if (geoLayer) map.removeLayer(geoLayer);
  geoLayer = L.geoJSON({ type: "FeatureCollection", features: filtered }, {
    filter: f => !f.properties.is_reef,
    pointToLayer: (feature, latlng) => {
      const p = feature.properties;
      const color = p.color || CAT_COLORS[p.category] || CAT_COLORS["Other"];
      const isStrategicParcel = STRATEGIC.some(s => s.address === p.address);
      return L.circleMarker(latlng, {
        radius:      isStrategicParcel ? 10 : 7,
        fillColor:   color,
        color:       isStrategicParcel ? "#ffffff" : color,
        weight:      isStrategicParcel ? 1.5 : 1,
        opacity:     0.8,
        fillOpacity: 0.75
      });
    },
    onEachFeature: (feature, layer) => {
      const p = feature.properties;
      const color = p.color || CAT_COLORS[p.category] || CAT_COLORS["Other"];
      const fmt = v => v ? "$" + Number(v).toLocaleString() : "—";

      layer.bindPopup(`
        <div class="popup-inner">
          <span class="popup-use-badge" style="background:${color}22;color:${color}">${p.category || "Other"}</span>
          <div class="popup-address">${p.address || "Unknown Address"}</div>
          <div class="popup-owner">${p.owner || "Unknown Owner"}</div>
          <div class="popup-stats">
            <div class="popup-stat"><div class="v">${fmt(p.assessed_value)}</div><div class="k">Assessed</div></div>
            <div class="popup-stat"><div class="v">${p.sqft ? Number(p.sqft).toLocaleString() + " sqft" : "—"}</div><div class="k">Size</div></div>
            <div class="popup-stat"><div class="v">${p.year_built || "—"}</div><div class="k">Built</div></div>
            <div class="popup-stat"><div class="v">${p.parcel_id || "—"}</div><div class="k">Parcel ID</div></div>
          </div>
          <a class="popup-link" href="https://www.whatcomcounty.us/1877/Property-Information" target="_blank">
            Whatcom County GIS &rarr;
          </a>
        </div>
      `, { maxWidth: 280 });

      layer.bindTooltip(p.address || "No address", { direction: "top", offset: [0, -6] });

      layer.on("click", () => {
        selectedId = p.parcel_id;
        renderList(filtered);
      });
    }
  }).addTo(map);

  renderList(filtered);
}

/* ─────────────────────────────────────────────────────────
   SIDEBAR LIST
───────────────────────────────────────────────────────── */
function renderList(features) {
  const container = document.getElementById("property-list");
  container.innerHTML = "";

  features.forEach(f => {
    const p = f.properties;
    const color = p.color || CAT_COLORS[p.category] || CAT_COLORS["Other"];
    const isStrategic = STRATEGIC.some(s => s.address === p.address);
    const item = document.createElement("div");
    item.className = "property-item" +
      (p.is_reef ? " is-reef" : "") +
      (isStrategic && !p.is_reef ? " is-strategic" : "") +
      (p.parcel_id === selectedId ? " selected" : "");

    const fmt = v => v ? "$" + (Number(v) / 1000).toFixed(0) + "K" : "—";
    item.innerHTML = `
      <div class="dot" style="background:${color}"></div>
      <div class="prop-info">
        <div class="prop-address">${p.address || "No address"}</div>
        <div class="prop-owner">${p.owner || "—"}</div>
      </div>
      <div class="prop-meta">
        <div class="prop-value">${fmt(p.assessed_value)}</div>
        <div class="prop-use">${p.category || "—"}</div>
      </div>
    `;

    if (f.geometry && f.geometry.coordinates) {
      item.addEventListener("click", () => {
        const [lng, lat] = f.geometry.coordinates;
        map.flyTo([lat, lng], 17, { duration: 1 });
        selectedId = p.parcel_id;
        renderList(features);
      });
    }

    container.appendChild(item);
  });
}

/* ─────────────────────────────────────────────────────────
   STATS BAR
───────────────────────────────────────────────────────── */
function buildStats() {
  const bar = document.getElementById("stats-bar");
  const total = allFeatures.length;
  const totalAssessed = allFeatures.reduce((s, f) => s + (Number(f.properties.assessed_value) || 0), 0);
  bar.innerHTML = `
    <div class="stat-pill"><strong>${total}</strong> parcels</div>
    <div class="stat-pill">Total assessed <strong>$${(totalAssessed / 1e6).toFixed(1)}M</strong></div>
    <div class="stat-pill">Target: <strong style="color:#f0c040">The Reef $1.375M ask</strong></div>
  `;
}

/* ─────────────────────────────────────────────────────────
   PRESENTATION
───────────────────────────────────────────────────────── */
let currentSlide = 0;
let presentationReady = false;

const SLIDES = [
  { num:"01", sect:"THE PROPERTY",       sub:"What is The Reef?",                                    fn: slideProperty   },
  { num:"02", sect:"THE REEF — PHOTOS",  sub:"Existing building, patio & waterfront — MLS\u00ae #2477253", fn: slidePhotos     },
  { num:"03", sect:"ACQUISITION TYPE",   sub:"This is a Conversion \u2014 not a Going Concern",           fn: slideConversion },
  { num:"04", sect:"THE PENCLAVE",        sub:"Domestic isolation via foreign intermediation",        fn: slidePenclave   },
  { num:"05", sect:"ADDRESSABLE MARKET", sub:"Who can actually get here?",                            fn: slideMarket     },
  { num:"06", sect:"BORDER RISK",         sub:"When the border closes, 80% of revenue disappears",   fn: slideClosure    },
  { num:"07", sect:"THE SEASON",          sub:"Revenue lives in 13 weeks",                            fn: slideSeason     },
  { num:"08", sect:"COST STACK",          sub:"Build costs first \u2014 revenue is what covers them",     fn: slideCosts      },
  { num:"09", sect:"AUTOMATION",          sub:"The penclave makes automation capital \u2014 not compromise", fn: slideAutomation },
  { num:"10", sect:"BREAK-EVEN",          sub:"How many members does it take?",                       fn: slideBreakeven  },
  { num:"11", sect:"CAPITAL REQUIRED",   sub:"Total outlay before first dollar of revenue",          fn: slideCapital    },
  { num:"12", sect:"GO / NO-GO",          sub:"The conditions that kill the deal",                    fn: slideGoNoGo     },
];

function initPresentation() {
  presentationReady = true;
  const dotsEl = document.getElementById("slide-dots");
  dotsEl.innerHTML = "";
  SLIDES.forEach((_, i) => {
    const dot = document.createElement("button");
    dot.className = "slide-dot" + (i === 0 ? " active" : "");
    dot.addEventListener("click", () => goToSlide(i));
    dotsEl.appendChild(dot);
  });
  document.getElementById("slide-prev").addEventListener("click", () => goToSlide(currentSlide - 1));
  document.getElementById("slide-next").addEventListener("click", () => goToSlide(currentSlide + 1));
  document.addEventListener("keydown", e => {
    if (!document.body.classList.contains("presentation-mode")) return;
    if (e.key === "ArrowRight" || e.key === "ArrowDown") goToSlide(currentSlide + 1);
    if (e.key === "ArrowLeft"  || e.key === "ArrowUp")   goToSlide(currentSlide - 1);
  });
  // Swipe gesture
  let _tx0 = 0, _ty0 = 0;
  const panel = document.getElementById("presentation-panel");
  panel.addEventListener("touchstart", e => {
    _tx0 = e.touches[0].clientX;
    _ty0 = e.touches[0].clientY;
  }, { passive: true });
  panel.addEventListener("touchend", e => {
    const dx = e.changedTouches[0].clientX - _tx0;
    const dy = e.changedTouches[0].clientY - _ty0;
    if (Math.abs(dx) > 40 && Math.abs(dx) > Math.abs(dy) * 1.5) {
      dx < 0 ? goToSlide(currentSlide + 1) : goToSlide(currentSlide - 1);
    }
  }, { passive: true });
  goToSlide(0);
}

function goToSlide(idx) {
  if (idx < 0 || idx >= SLIDES.length) return;
  currentSlide = idx;
  const s = SLIDES[idx];
  document.getElementById("slide-title").textContent    = s.num + " / " + s.sect;
  document.getElementById("slide-subtitle").textContent = s.sub;
  document.getElementById("slide-counter").textContent  = (idx + 1) + " / " + SLIDES.length;
  document.querySelectorAll(".slide-dot").forEach((d, i) => d.classList.toggle("active", i === idx));
  document.getElementById("slide-prev").disabled = idx === 0;
  document.getElementById("slide-next").disabled = idx === SLIDES.length - 1;
  const viz = document.getElementById("slide-viz");
  viz.style.opacity = "0";
  while (viz.firstChild) viz.removeChild(viz.firstChild);
  d3.select("#slide-viz").selectAll("svg").remove();
  setTimeout(() => { s.fn(viz); viz.style.opacity = "1"; }, 80);
  pushState();
}

// helpers
function sEl(tag, cls, html) {
  const e = document.createElement(tag);
  if (cls)  e.className = cls;
  if (html !== undefined) e.innerHTML = html;
  return e;
}
function sWrap(cls)  { return sEl("div", cls); }
function sNote(txt)  { return sEl("p",   "snote", txt); }
function sVizW()     { return (document.getElementById("slide-viz").clientWidth - 96) || 660; }

/* ── Slide 1: The Property ── */
function slideProperty(c) {
  const grid = sWrap("sstat-grid");
  [{ v:"$1,375,000", k:"Asking Price",         cls:"s-hi"  },
   { v:"$850,965",   k:"Assessed Value",        cls:""     },
   { v:"+61.6%",     k:"Ask vs Assessed",       cls:"s-warn"},
   { v:"≤2,500 sqft",k:"Est. Building Area [E]",cls:""     },
   { v:"Built 1959", k:"Year Built",            cls:""     },
   { v:"RESORT COMM",k:"Zoning",               cls:"s-ok" }]
  .forEach(s => { const d = sEl("div","sstat "+s.cls); d.innerHTML=`<div class="sv">${s.v}</div><div class="sk">${s.k}</div>`; grid.appendChild(d); });
  c.appendChild(grid);

  const cw = sWrap("schart-wrap");
  cw.appendChild(sEl("div","schart-title","Value component breakdown — where the money actually is"));
  const cd = sEl("div"); cd.id="sp-chart"; cw.appendChild(cd);
  cw.appendChild(sNote("[V] Whatcom County 2025 assessed values. Land ($669K) is the load-bearing component — improvements on a 1959 building carry minimal residual structural value. The asking price premium of $524K above assessed reflects the business value and/or seller expectations."));
  c.appendChild(cw);

  const data = [
    { label:"Land value",       val:669526,  color:"#4caf50" },
    { label:"Improvement value",val:181439,  color:"#7ab5d8" },
    { label:"Total assessed",   val:850965,  color:"#5a7a94" },
    { label:"Asking price",     val:1375000, color:"#f0c040" },
  ];
  const W=sVizW(), H=160, ml=165, mr=90, mt=8, mb=8;
  const bw=W-ml-mr, bh=H-mt-mb;
  const x=d3.scaleLinear().domain([0,1500000]).range([0,bw]);
  const y=d3.scaleBand().domain(data.map(d=>d.label)).range([0,bh]).padding(0.32);
  const svg=d3.select("#sp-chart").append("svg").attr("width",W).attr("height",H)
    .append("g").attr("transform",`translate(${ml},${mt})`);
  svg.selectAll("rect").data(data).join("rect")
    .attr("y",d=>y(d.label)).attr("height",y.bandwidth()).attr("x",0).attr("width",0).attr("rx",4)
    .attr("fill",d=>d.color).attr("opacity",0.85)
    .transition().duration(600).delay((_,i)=>i*100).attr("width",d=>x(d.val));
  svg.selectAll(".lbl").data(data).join("text").attr("class","lbl")
    .attr("x",-6).attr("y",d=>y(d.label)+y.bandwidth()/2+4)
    .attr("text-anchor","end").attr("fill","#8090a0").attr("font-size","11px").text(d=>d.label);
  svg.selectAll(".val").data(data).join("text").attr("class","val")
    .attr("x",d=>x(d.val)+6).attr("y",d=>y(d.label)+y.bandwidth()/2+4)
    .attr("fill",d=>d.color).attr("font-size","11px").attr("font-weight","700")
    .text(d=>"$"+(d.val/1000).toFixed(0)+"K");
}

/* ── Slide 2: Photos ── */
function slidePhotos(c) {
  // Hero — featured listing photo (patio / waterfront)
  const hero = sWrap("sphoto-hero");
  const heroImg = document.createElement("img");
  heroImg.src = "https://cdn.listingphotos.sierrastatic.com/pics3x/v1770342736/152/152_2477253_01.jpg";
  heroImg.alt = "The Reef — waterfront view, 1334 Gulf Rd, Point Roberts WA";
  heroImg.className = "sphoto-hero-img";
  hero.appendChild(heroImg);
  const cap = sEl("div", "sphoto-caption", "Kiniski\u2019s Reef Tavern \u00b7 1334 Gulf Rd, Point Roberts WA 98281 \u00b7 MLS\u00ae #2477253 \u00b7 Listed \u00a0 $1,375,000");
  hero.appendChild(cap);
  c.appendChild(hero);

  // Thumbnail strip — photos 02-05 (confirmed CDN URLs)
  const THUMBS = [
    { n:"02", v:"v1770342768" },
    { n:"03", v:"v1770342769" },
    { n:"04", v:"v1770342770" },
    { n:"05", v:"v1770342771" },
  ];
  const grid = sEl("div", "sphoto-grid");
  THUMBS.forEach(t => {
    const base = `https://cdn.listingphotos.sierrastatic.com/pics1x/${t.v}/152/152_2477253_${t.n}.jpg`;
    const a = document.createElement("a");
    a.href = base; a.target = "_blank"; a.rel = "noopener";
    const img = document.createElement("img");
    img.src = base; img.alt = `Photo ${t.n}`;
    a.appendChild(img);
    grid.appendChild(a);
  });
  c.appendChild(grid);

  // Links section
  const lw = sEl("div", "sphoto-links");
  lw.appendChild(sEl("div", "sphoto-links-title", "Listing sources \u2014 38 photos available"));
  const LINKS = [
    { href: "https://www.washingtonwaterfronts.com/property/1334-gulf-rd-point-roberts-wa-98281/pid-15151627/",
      label: "Washington Waterfronts \u2014 full gallery (38 photos), MLS\u00ae #2477253" },
    { href: "https://www.loopnet.com/Listing/1334-Gulf-Rd-Point-Roberts-WA/32585395/",
      label: "LoopNet commercial listing #32585395" },
    { href: "https://www.kiniskisreef.com/",
      label: "kiniskisreef.com \u2014 official bar website" },
    { href: "https://www.kiniskisreef.com/private_events.html",
      label: "kiniskisreef.com — events & patio photos" },
    { href: "https://m.yelp.com/biz/kiniskis-reef-tavern-point-roberts",
      label: "Yelp \u2014 Kiniski\u2019s Reef Tavern reviews & photos" },
    { href: "https://www.tripadvisor.ca/Restaurant_Review-g58681-d4375086-Reviews-Kiniski_s_Reef_Tavern-Point_Roberts_Washington.html",
      label: "TripAdvisor \u2014 Kiniski\u2019s Reef Tavern" },
  ];
  LINKS.forEach((lk, i) => {
    const row = sEl("div", "sphoto-link-row");
    row.appendChild(sEl("span", "sphoto-link-num", String(i + 1)));
    const a = document.createElement("a");
    a.href = lk.href; a.target = "_blank"; a.rel = "noopener";
    a.className = "sphoto-link"; a.textContent = lk.label;
    row.appendChild(a);
    lw.appendChild(row);
  });
  c.appendChild(lw);
}

/* ── Slide 3: Conversion ── */
function slideConversion(c) {
  const cols = sWrap("s2col");
  const buying = sWrap("s2col-card dim");
  buying.innerHTML = `<h4>What you\'re buying</h4>`;
  ["A 1959 building assessed at $851K",
   "A bar operating as \"DRINK PLACES\" since ~1959",
   "Trailing bar revenue (irrelevant to club model)",
   "Bar customers — none of whom joined a club",
   "An on-premise liquor license (Class 12 or 14)",
   "Owner: Nicholas C. Kiniski"
  ].forEach(r => { const d=sEl("div","s2col-row"); d.textContent=r; buying.appendChild(d); });
  const building = sWrap("s2col-card bright");
  building.innerHTML = `<h4>What you\'re building</h4>`;
  ["A member-owned beach club — purpose-converted",
   "Year 1: zero members, zero revenue (greenfield)",
   "New income model: dues + F&B + events",
   "Members must be recruited from scratch",
   "Class 6 Club License — WA (new application)",
   "Renovation required: $250K–$500K [E]"
  ].forEach(r => { const d=sEl("div","s2col-row"); d.textContent=r; building.appendChild(d); });
  cols.appendChild(buying); cols.appendChild(building); c.appendChild(cols);
  c.appendChild(sEl("div","shighlight",
    '<span class="sbold">The bar\'s trailing revenue does not justify club revenue projections.</span> The existing business is only useful for: (a) whether the liquor license transfers to a members club use, (b) what the physical plant costs to operate, and (c) what the seller is actually selling.'));
  c.appendChild(sEl("div","srisk",
    '<span class="sbold">Transition risk:</span> Zero revenue during conversion. Carry costs run regardless — debt service + property tax + utilities + insurance for 15–18 months = <span class="sbold">estimated $150–200K [E]</span> before the first member walks in.'));
}

/* ── Slide 3: Penclave ── */
function slidePenclave(c) {
  const d = sWrap("penclave-diagram");
  const us = sWrap("pcl-side us-side");
  us.innerHTML = `
    <div class="pcl-label">US Member — Bellingham WA</div>
    <div class="pcl-big">4×</div>
    <div class="pcl-desc">border crossings per round trip</div>
    <div class="pcl-steps">
      <span class="pcl-node">WA mainland</span><span class="pcl-arrow">→</span>
      <span class="pcl-border">BORDER</span><span class="pcl-arrow">→</span>
      <span class="pcl-node">Canada</span><span class="pcl-arrow">→</span>
      <span class="pcl-border">BORDER</span><span class="pcl-arrow">→</span>
      <span class="pcl-node">Point Roberts</span>
    </div>
    <div class="pcl-steps">
      <span class="pcl-node">Point Roberts</span><span class="pcl-arrow">→</span>
      <span class="pcl-border">BORDER</span><span class="pcl-arrow">→</span>
      <span class="pcl-node">Canada</span><span class="pcl-arrow">→</span>
      <span class="pcl-border">BORDER</span><span class="pcl-arrow">→</span>
      <span class="pcl-node">WA mainland</span>
    </div>
    <div class="pcl-desc" style="margin-top:8px">2–5 hrs total travel in summer</div>`;
  const ca = sWrap("pcl-side ca-side");
  ca.innerHTML = `
    <div class="pcl-label">Canadian Member — Tsawwassen BC</div>
    <div class="pcl-big">1×</div>
    <div class="pcl-desc">border crossing per round trip</div>
    <div class="pcl-steps">
      <span class="pcl-node">Tsawwassen BC</span><span class="pcl-arrow">→</span>
      <span class="pcl-border">BORDER</span><span class="pcl-arrow">→</span>
      <span class="pcl-node">Point Roberts</span>
    </div>
    <div class="pcl-steps" style="margin-top:6px">
      <span class="pcl-node">20,933 people</span>
      <span class="pcl-arrow">·</span>
      <span class="pcl-node">5–10 min drive</span>
    </div>
    <div class="pcl-desc" style="margin-top:8px;color:#3a8060">Most accessible market = foreign nationals</div>`;
  d.appendChild(us); d.appendChild(ca); c.appendChild(d);
  c.appendChild(sEl("div","shighlight",
    '<span class="sbold">Key implication:</span> US membership is a secondary market. 4 crossings per round trip + 30–90 min peak wait times each direction = up to 5 hours of travel for a beach club visit. US members will visit far less frequently than any non-penclave comparable. Do not use mainland club visit-frequency assumptions.'));
  const cw = sWrap("schart-wrap");
  cw.appendChild(sEl("div","schart-title","Other structural dependencies"));
  const rows = [
    ["Water supply",    "Sourced from Greater Vancouver Water District (Delta, BC) — confirmed [V]"],
    ["Supply chain",    "Every delivery through Canadian customs. +8–15% COGS premium [E]"],
    ["Fire coverage",   "Volunteer fire dept + Delta Fire Dept cross-border assistance [V]"],
    ["Local labor",     "Year-round population: 1,191 (median age 52.7). Not a hospitality labor pool."],
    ["Real estate exit","Buyer pool limited to penclave-accepting purchasers. Suppressed floor value."],
  ];
  const tbl = sEl("table","gono-tbl");
  rows.forEach(([dep, note]) => {
    const tr = sEl("tr");
    tr.innerHTML = `<td class="cond-col" style="width:150px;font-size:12px">${dep}</td><td class="thresh-col">${note}</td>`;
    tbl.appendChild(tr);
  });
  cw.appendChild(tbl); c.appendChild(cw);
}

/* ── Slide 4: Addressable Market ── */
function slideMarket(c) {
  const cw = sWrap("schart-wrap");
  cw.appendChild(sEl("div","schart-title","Addressable market by segment — population and access friction"));
  const cd = sEl("div"); cd.id="sm-chart"; cw.appendChild(cd);
  cw.appendChild(sNote("[V] Statistics Canada 2021, US Census 2020. Tier 1 = directly adjacent, 1 crossing, ≤20 min. Tier 2 = 1 crossing but competing with border-free local beaches. US = 4 crossings per visit."));
  c.appendChild(cw);
  const segs = [
    { label:"Metro Van (Tier 2)",   pop:1700000, type:"ca-far"  },
    { label:"Vancouver city",       pop: 675000, type:"ca-far"  },
    { label:"Surrey",               pop: 590000, type:"ca-far"  },
    { label:"Whatcom Co. US",       pop: 230000, type:"us"      },
    { label:"Richmond BC",          pop: 232000, type:"ca-far"  },
    { label:"White Rock / S Surrey",pop: 110000, type:"ca-near" },
    { label:"Ladner",               pop:  21112, type:"ca-near" },
    { label:"Tsawwassen",           pop:  20933, type:"ca-near" },
  ].sort((a,b) => b.pop - a.pop);
  const colors = { "ca-near":"#4caf50", "ca-far":"rgba(74,175,80,0.35)", "us":"#e07840" };
  const W=sVizW(), H=280, ml=185, mr=95, mt=12, mb=10;
  const bw=W-ml-mr, bh=H-mt-mb;
  const x=d3.scaleLinear().domain([0,d3.max(segs,d=>d.pop)]).range([0,bw]);
  const y=d3.scaleBand().domain(segs.map(d=>d.label)).range([0,bh]).padding(0.3);
  const svg=d3.select("#sm-chart").append("svg").attr("width",W).attr("height",H)
    .append("g").attr("transform",`translate(${ml},${mt})`);
  const nearLabels=segs.filter(d=>d.type==="ca-near").map(d=>d.label);
  if (nearLabels.length) {
    const y0=y(nearLabels[0]), y1=y(nearLabels[nearLabels.length-1])+y.bandwidth();
    svg.append("rect").attr("x",-ml+8).attr("width",bw+ml-8).attr("y",y0-5).attr("height",y1-y0+10)
      .attr("fill","rgba(76,175,80,0.07)").attr("rx",3);
    svg.append("text").attr("x",bw+6).attr("y",(y0+y1)/2+4)
      .attr("fill","#4caf50").attr("font-size","10px").attr("font-weight","700").text("Tier 1");
  }
  svg.selectAll("rect.bar").data(segs).join("rect").attr("class","bar")
    .attr("y",d=>y(d.label)).attr("height",y.bandwidth())
    .attr("x",0).attr("width",0).attr("rx",3)
    .attr("fill",d=>colors[d.type]).attr("opacity",0.9)
    .transition().duration(700).delay((_,i)=>i*70).attr("width",d=>x(d.pop));
  svg.selectAll(".lbl").data(segs).join("text").attr("class","lbl")
    .attr("x",-6).attr("y",d=>y(d.label)+y.bandwidth()/2+4)
    .attr("text-anchor","end").attr("fill","#7090a8").attr("font-size","11px").text(d=>d.label);
  svg.selectAll(".popval").data(segs).join("text").attr("class","popval")
    .attr("x",d=>x(d.pop)+6).attr("y",d=>y(d.label)+y.bandwidth()/2+4)
    .attr("fill",d=>colors[d.type]).attr("font-size","11px").attr("font-weight","600")
    .text(d=>d.pop>=1e6?(d.pop/1e6).toFixed(1)+"M":(d.pop/1000).toFixed(0)+"K");
  c.appendChild(sEl("div","shighlight",
    '<span class="sbold">Primary realistic market:</span> ~152K people (Tier 1 Canadian) within 20 min + 1 crossing. <span class="sbold">US addressable:</span> ~30K realistic candidates from Whatcom County — highly friction-limited. Model <em>must</em> show the scenario where Canadian demand drops 30% (2025 tariff baseline, documented).'));
}

/* ── Slide 5: Border Risk ── */
function slideClosure(c) {
  const grid = sWrap("sstat-grid");
  [{ v:"17 months", k:"Border closure, March 2020 – Aug 2021 [V]",   cls:"s-warn" },
   { v:"–80%",     k:"Point Roberts business revenue lost [V]",       cls:"s-warn" },
   { v:"–30%",     k:"Canadian visitors, 2025 tariff event [V]",      cls:"s-warn" }]
  .forEach(s => { const d=sEl("div","sstat "+s.cls); d.innerHTML=`<div class="sv">${s.v}</div><div class="sk">${s.k}</div>`; grid.appendChild(d); });
  c.appendChild(grid);
  const cw = sWrap("schart-wrap");
  cw.appendChild(sEl("div","schart-title","Point Roberts revenue capacity over time (schematic)"));
  const cd = sEl("div"); cd.id="sc-chart"; cw.appendChild(cd);
  cw.appendChild(sNote("[V] Border closure March 2020–August 2021 (Wikipedia, CBC News). \"Ghost town\" — 80% revenue loss (local chamber of commerce, CBC Sep 2020). Feb 2021: Canada waived COVID testing for PR residents after WA state negotiations. 2025 tariff events: Guardian June 2025."));
  c.appendChild(cw);
  const pts = [
    {t:0,  rev:100},{t:1,  rev:100},
    {t:1.24,rev:100},{t:1.26,rev:20},
    {t:1.6, rev:22},{t:2.1, rev:26},
    {t:2.58,rev:26},{t:2.62,rev:78},
    {t:3,  rev:88},{t:4,  rev:100},
    {t:5.24,rev:100},{t:5.26,rev:70},
    {t:6,  rev:70},
  ];
  const W=sVizW(), H=190, ml=36, mr=16, mt=12, mb=28;
  const bw=W-ml-mr, bh=H-mt-mb;
  const x=d3.scaleLinear().domain([0,6]).range([0,bw]);
  const y=d3.scaleLinear().domain([0,115]).range([bh,0]);
  const svg=d3.select("#sc-chart").append("svg").attr("width",W).attr("height",H)
    .append("g").attr("transform",`translate(${ml},${mt})`);
  svg.append("rect").attr("x",x(1.24)).attr("width",x(2.62)-x(1.24)).attr("y",0).attr("height",bh).attr("fill","rgba(224,80,64,0.1)");
  svg.append("text").attr("x",(x(1.24)+x(2.62))/2).attr("y",bh-4).attr("text-anchor","middle").attr("fill","#e05040").attr("font-size","10px").attr("font-weight","700").text("17 MONTHS CLOSED");
  svg.append("rect").attr("x",x(5.24)).attr("width",bw-x(5.24)).attr("y",0).attr("height",bh).attr("fill","rgba(212,176,64,0.1)");
  svg.append("text").attr("x",(x(5.24)+bw)/2-8).attr("y",14).attr("text-anchor","middle").attr("fill","#d4b040").attr("font-size","9px").text("tariffs");
  const area=d3.area().x(d=>x(d.t)).y0(bh).y1(d=>y(d.rev)).curve(d3.curveMonotoneX);
  svg.append("path").datum(pts).attr("fill","rgba(76,175,80,0.12)").attr("d",area);
  const ln=d3.line().x(d=>x(d.t)).y(d=>y(d.rev)).curve(d3.curveMonotoneX);
  const p=svg.append("path").datum(pts).attr("fill","none").attr("stroke","#4caf50").attr("stroke-width",2).attr("d",ln);
  const len=p.node().getTotalLength();
  p.attr("stroke-dasharray",len).attr("stroke-dashoffset",len).transition().duration(1200).attr("stroke-dashoffset",0);
  const years=["2019","2020","2021","2022","2023","2024","2025","2026"];
  years.forEach((yr,i) => svg.append("text").attr("x",x(i)).attr("y",bh+14).attr("text-anchor","middle").attr("fill","#5a7a94").attr("font-size","10px").text(yr));
  svg.append("g").call(d3.axisLeft(y).ticks(4).tickFormat(d=>d+"%")).selectAll("text").attr("fill","#5a7a94").attr("font-size","10px");
  svg.selectAll(".domain,.tick line").attr("stroke","#1e3048");
  c.appendChild(sEl("div","srisk",
    '<span class="sbold">This is not a tail risk — it is a documented recent event.</span> A border closure happened and lasted 17 months. Any financial model must include a closure scenario. Estimate: <span class="sbold">$700K–$1M cash reserve required [E]</span> to survive an 18-month closure at near-zero Canadian revenue.'));
}

/* ── Slide 6: The Season ── */
function slideSeason(c) {
  const cw = sWrap("schart-wrap");
  cw.appendChild(sEl("div","schart-title","Monthly revenue potential vs. fixed cost floor (relative %)"));
  const cd = sEl("div"); cd.id="ss-chart"; cw.appendChild(cd);
  cw.appendChild(sNote("[E] Revenue profile from Delta/Tsawwassen climate normals (Environment Canada 1981–2010). Beach weather (≥19°C avg high, low rain) = mid-June through mid-September ≈ 13 weeks. Cost floor = fixed charges (debt, labor overhead, tax, insurance) as % of peak revenue capacity — runs year-round."));
  c.appendChild(cw);
  const mos = [{m:"Jan",r:8},{m:"Feb",r:8},{m:"Mar",r:12},{m:"Apr",r:18},{m:"May",r:32},
               {m:"Jun",r:62},{m:"Jul",r:100},{m:"Aug",r:98},{m:"Sep",r:60},
               {m:"Oct",r:22},{m:"Nov",r:10},{m:"Dec",r:8}];
  const beach=["Jun","Jul","Aug","Sep"], cf=50;
  const W=sVizW(), H=200, ml=40, mr=10, mt=14, mb=28;
  const bw=W-ml-mr, bh=H-mt-mb;
  const x=d3.scaleBand().domain(mos.map(d=>d.m)).range([0,bw]).padding(0.2);
  const y=d3.scaleLinear().domain([0,115]).range([bh,0]);
  const svg=d3.select("#ss-chart").append("svg").attr("width",W).attr("height",H)
    .append("g").attr("transform",`translate(${ml},${mt})`);
  const bx0=x("Jun"), bx1=x("Sep")+x.bandwidth();
  svg.append("rect").attr("x",bx0-2).attr("width",bx1-bx0+4).attr("y",-4).attr("height",bh+4).attr("fill","rgba(240,192,64,0.07)").attr("rx",3);
  svg.append("text").attr("x",(bx0+bx1)/2).attr("y",-1).attr("text-anchor","middle").attr("fill","#f0c040").attr("font-size","9px").attr("font-weight","700").text("← 13-week beach season →");
  svg.selectAll("rect.bar").data(mos).join("rect").attr("class","bar")
    .attr("x",d=>x(d.m)).attr("width",x.bandwidth())
    .attr("y",bh).attr("height",0).attr("rx",2)
    .attr("fill",d=>beach.includes(d.m)?"#f0c040":"#3a6080").attr("opacity",0.85)
    .transition().duration(600).delay((_,i)=>i*50)
    .attr("y",d=>y(d.r)).attr("height",d=>bh-y(d.r));
  svg.append("line").attr("x1",0).attr("x2",bw).attr("y1",y(cf)).attr("y2",y(cf)).attr("stroke","#e05040").attr("stroke-width",1.5).attr("stroke-dasharray","4,3");
  svg.append("text").attr("x",bw+4).attr("y",y(cf)+4).attr("fill","#e05040").attr("font-size","9px").text("costs");
  svg.append("g").attr("transform",`translate(0,${bh})`).call(d3.axisBottom(x)).selectAll("text").attr("fill","#5a7a94").attr("font-size","10px");
  svg.append("g").call(d3.axisLeft(y).ticks(4).tickFormat(d=>d+"%")).selectAll("text").attr("fill","#5a7a94").attr("font-size","10px");
  svg.selectAll(".domain,.tick line").attr("stroke","#1e3048");
  c.appendChild(sEl("div","shighlight",
    '<span class="sbold">Critical structure:</span> Fixed costs run 12 months. Revenue is concentrated in 13 weeks. The model must be built month-by-month — not as an annual average. The off-season question is: can dues alone cover fixed costs October–May, or does the club need to suspend operations?'));
}

function slideCosts(c) {
  const M = MODEL;
  // Show BASELINE labor bands on this slide (motivates automation slide)
  const costs = M.costs.map((x, i) => ({
    label: x.label,
    low:   i === 0 ? (x.baselineLo || x.lo) : x.lo,
    high:  i === 0 ? (x.baselineHi || x.hi) : x.hi,
    color: x.color,
  }));
  const tlo=costs.reduce((s,c)=>s+c.low,0), thi=costs.reduce((s,c)=>s+c.high,0);
  const grid = sWrap("sstat-grid");
  [{v:"$"+(tlo/1000).toFixed(0)+"K",k:"Annual cost floor [E]",cls:""},{v:"$"+(thi/1000).toFixed(0)+"K",k:"Annual cost ceiling [E]",cls:"s-warn"},{v:`${M.laborShareLo}\u2013${M.laborShareHi}%`,k:"Labor share of total costs [E]",cls:""}]
  .forEach(s => { const d=sEl("div","sstat "+s.cls); d.innerHTML=`<div class="sv">${s.v}</div><div class="sk">${s.k}</div>`; grid.appendChild(d); });
  c.appendChild(grid);
  const cw = sWrap("schart-wrap");
  cw.appendChild(sEl("div","schart-title","Annual cost stack — low (solid) to high (faded) [E]"));
  const cd = sEl("div"); cd.id="sco-chart"; cw.appendChild(cd);
  cw.appendChild(sNote("[E] Labor: GM $130–160K + 2–3 seasonal staff × 13 weeks, +25–40% penclave premium. No mortgage — 250 shares fund acquisition. Buyback reserve: liquidity pool for share exits. F&B COGS at 35% of $255K gross F&B/events revenue. Property tax ~1.1% of $850K assessed."));
  c.appendChild(cw);
  const W=sVizW(), H=240, ml=170, mr=100, mt=8, mb=8;
  const bw=W-ml-mr, bh=H-mt-mb;
  const x=d3.scaleLinear().domain([0,thi*1.05]).range([0,bw]);
  const y=d3.scaleBand().domain(costs.map(d=>d.label)).range([0,bh]).padding(0.3);
  const svg=d3.select("#sco-chart").append("svg").attr("width",W).attr("height",H)
    .append("g").attr("transform",`translate(${ml},${mt})`);
  svg.selectAll(".bbg").data(costs).join("rect").attr("class","bbg")
    .attr("y",d=>y(d.label)).attr("height",y.bandwidth())
    .attr("x",0).attr("width",0).attr("rx",3)
    .attr("fill",d=>d.color).attr("opacity",0.22)
    .transition().duration(500).delay((_,i)=>i*60).attr("width",d=>x(d.high));
  svg.selectAll(".bfg").data(costs).join("rect").attr("class","bfg")
    .attr("y",d=>y(d.label)).attr("height",y.bandwidth())
    .attr("x",0).attr("width",0).attr("rx",3)
    .attr("fill",d=>d.color).attr("opacity",0.85)
    .transition().duration(500).delay((_,i)=>i*60).attr("width",d=>x(d.low));
  svg.selectAll(".lbl").data(costs).join("text").attr("class","lbl")
    .attr("x",-6).attr("y",d=>y(d.label)+y.bandwidth()/2+4)
    .attr("text-anchor","end").attr("fill","#7090a8").attr("font-size","11px").text(d=>d.label);
  svg.selectAll(".vr").data(costs).join("text").attr("class","vr")
    .attr("x",d=>x(d.high)+5).attr("y",d=>y(d.label)+y.bandwidth()/2+4)
    .attr("fill",d=>d.color).attr("font-size","10px")
    .text(d=>"$"+(d.low/1000).toFixed(0)+"–"+(d.high/1000).toFixed(0)+"K");
}

/* ── Slide 8: Automation ── */
function slideAutomation(c) {
  const M = MODEL, lc = M.costs[0];
  const blo = lc.baselineLo||lc.lo, bhi = lc.baselineHi||lc.hi;
  const grid = sWrap("sstat-grid");
  [{v:`$${(blo/1000)|0}\u2013${(bhi/1000)|0}K`,                         k:"Baseline labor (no automation) [E]",  cls:"s-warn"},
   {v:`$${(lc.lo/1000)|0}\u2013${(lc.hi/1000)|0}K`,                     k:"Automated labor model [E]",           cls:"s-ok"  },
   {v:`$${(M.laborSavingLo/1000)|0}\u2013${(M.laborSavingHi/1000)|0}K`, k:"Annual saving [E]",                   cls:"s-ok"  },
   {v:`$${(M.autoCapexLo/1000)|0}\u2013${(M.autoCapexHi/1000)|0}K`,     k:"Est. automation capex (in reno) [E]", cls:""      }]
  .forEach(s => { const d=sEl("div","sstat "+s.cls); d.innerHTML=`<div class="sv">${s.v}</div><div class="sk">${s.k}</div>`; grid.appendChild(d); });
  c.appendChild(grid);

  const cols = sWrap("s2col");

  const yes = sWrap("s2col-card bright");
  yes.innerHTML = `<h4>Automate — person adds nothing here</h4>`;
  [
    { t:"Member access",      n:"RFID/app gate. Works 24\u202f×\u202f7, survives no-show staff." },
    { t:"Grounds & lawn",     n:"Robot mowers overnight. Beachfront turf is significant." },
    { t:"Interior cleaning", n:"Commercial robot vacuums between sessions." },
    { t:"Pool / spa chemistry",n:"Auto-dosing + robot cleaner. Liability risk if missed." },
    { t:"Food prep",          n:"Programmable kitchen equipment, portion control, batch cooking. Reduces prep labour heavily without touching the guest experience." },
    { t:"Security & monitoring",n:"Cameras + app alerts. Replaces overnight presence." },
    { t:"HVAC & energy",      n:"Occupancy sensors + smart zones. 1959 envelope = huge waste." },
    { t:"Reservations & booking",n:"Member app handles court/cabana/event slots." },
  ].forEach(r => {
    const d = sEl("div","s2col-row");
    d.innerHTML = `<strong style="color:#a0d8b0">${r.t}</strong> \u2014 ${r.n}`;
    yes.appendChild(d);
  });

  const no = sWrap("s2col-card dim");
  no.innerHTML = `<h4 style="color:#e07840">Keep human — presence is the product</h4>`;
  [
    { t:"Food & drink service",n:"Table service and bar presence is a core reason members pay $6–8K/yr. A robot bringing drinks signals budget motel, not somewhere worth belonging to." },
    { t:"Bartending",          n:"Wine and cocktail service is hospitality signal. One skilled bartender during peak hours is a feature, not a cost." },
    { t:"Event hosting",       n:"Members at events expect a human point of contact." },
    { t:"Membership sales",    n:"Founding members are recruited by a person they trust." },
    { t:"Guest greeting",      n:"First impression at arrival. Especially important for Canadian members seeing a US border operation." },
  ].forEach(r => {
    const d = sEl("div","s2col-row");
    d.innerHTML = `<strong style="color:#c08060">${r.t}</strong> \u2014 ${r.n}`;
    no.appendChild(d);
  });

  cols.appendChild(yes); cols.appendChild(no); c.appendChild(cols);

  const cw = sWrap("schart-wrap");
  cw.appendChild(sEl("div","schart-title","Remaining staffing model post-automation [E]"));
  const rows = [
    ["Owner-operator / GM",  "1 person, lives locally or on-site. Full-time, year-round. Covers management, member relations, compliance."],
    ["Peak seasonal staff",   "2\u20133 people \u00d7 13 weeks only (bar service + floor). ~$40\u201396K total seasonal labour."],
    ["Year-round FTE beyond GM", "Zero. Automation covers the gap."],
  ];
  const tbl = sEl("table","gono-tbl");
  rows.forEach(([role, note]) => {
    const tr = sEl("tr");
    tr.innerHTML = `<td class="cond-col" style="width:200px;font-size:12px">${role}</td><td class="thresh-col">${note}</td>`;
    tbl.appendChild(tr);
  });
  cw.appendChild(tbl); c.appendChild(cw);

  c.appendChild(sEl("div","shighlight",
    `Break-even impact: automation capex (~$${(M.autoCapexLo/1000)|0}\u2013${(M.autoCapexHi/1000)|0}K) is absorbed into the renovation budget. The $${(M.laborSavingLo/1000)|0}\u2013${(M.laborSavingHi/1000)|0}K/yr labour saving reduces the dues burden from ~$${Math.round(M.burdenBase/1000)}K to <span class="sbold">~$${Math.round(M.burdenAuto/1000)}K [E]</span> \u2014 shifting break-even from ~${M.mBaseBreak} members down to <span class="sbold">~${M.mAutoBreak} members at avg $${M.avgDues.toLocaleString()} dues [E]</span>.`));
}

/* ── Slide 9: Break-Even ── */
function slideBreakeven(c) {
  const M = MODEL;
  const burdenBase = M.burdenBase, burdenAuto = M.burdenAuto;
  const foundingN = M.foundingN, foundingDues = M.foundingDues, regDues = M.avgDues;
  const foundingContrib = M.foundingContrib;
  const burdenRemain    = M.burdenRemain;
  const mFoundBreak     = M.mFoundBreak;

  const grid = sWrap("sstat-grid");
  [{v:`~${M.mBaseBreak}`,                  k:`Baseline: members @ avg $${M.avgDues.toLocaleString()} dues [E]`,                         cls:"s-warn"},
   {v:`~${M.mAutoBreak}`,                  k:`Automated: members @ avg $${M.avgDues.toLocaleString()} dues [E]`,                        cls:"s-ok"  },
   {v:`~${Math.round(M.mFoundBreak)}`,     k:`Founding mix: ${M.foundingN}\u00d7$${(M.foundingDues/1000).toFixed(1)}K + rest@avg [E]`,  cls:""      },
   {v:`$${M.foundingDues.toLocaleString()}`, k:`Founding rate \u00b7 ${M.foundingN} spots [E]`,                                         cls:"s-ok"  },
   {v:`~$${Math.round(M.burdenAuto/1000)}K`, k:"Automated dues burden [E]",                                                              cls:""      },
   {v:`\u2212${M.burdenReduction}%`,       k:"Burden reduction from automation",                                                        cls:"s-ok"  }]
  .forEach(s => { const d=sEl("div","sstat "+s.cls); d.innerHTML=`<div class="sv">${s.v}</div><div class="sk">${s.k}</div>`; grid.appendChild(d); });
  c.appendChild(grid);

  const cw = sWrap("schart-wrap");
  cw.appendChild(sEl("div","schart-title","Required dues per member to break even — baseline · automated · founding mix [E]"));
  const cd = sEl("div"); cd.id="sbe-chart"; cw.appendChild(cd);
  const laborDelta = M.laborBaseMid - M.laborAutoMid;
  const extraM = Math.round(M.burdenRemain / M.avgDues);
  cw.appendChild(sNote(`[E] Baseline burden $${Math.round(M.burdenBase/1000)}K (baseline labor, no debt). Automated $${Math.round(M.burdenAuto/1000)}K (\u2212$${Math.round(laborDelta/1000)}K labor). Founding mix: ${M.foundingN}\u00d7$${M.foundingDues.toLocaleString()} = $${(M.foundingContrib/1000).toFixed(1)}K \u2192 remaining $${(M.burdenRemain/1000).toFixed(1)}K \u00f7 $${M.avgDues.toLocaleString()} = ${extraM} more regular members \u2192 ${Math.round(M.mFoundBreak)} total. Share funding eliminates mortgage \u2014 no debt service in burden. F&B/events ($${Math.round(M.fbGross/1000)}K gross) offset costs directly.`));
  c.appendChild(cw);

  const mrng = d3.range(20, 151, 5);
  const ptsBase = mrng.map(m => ({m, d: burdenBase / m}));
  const ptsAuto = mrng.map(m => ({m, d: burdenAuto / m}));
  // Founding mix: required dues from (N − 25) regular members to cover remaining $75.5K burden
  const mrngF = d3.range(foundingN + 2, 151, 2);
  const ptsFnd = mrngF.map(m => ({m, d: burdenRemain / (m - foundingN)}));

  const W=sVizW(), H=220, ml=58, mr=24, mt=20, mb=32;
  const bw=W-ml-mr, bh=H-mt-mb;
  const x = d3.scaleLinear().domain([20, 150]).range([0, bw]);
  const yMax = d3.max(ptsBase, d => d.d) * 1.1;
  const y = d3.scaleLinear().domain([0, yMax]).range([bh, 0]);
  const svg = d3.select("#sbe-chart").append("svg").attr("width",W).attr("height",H)
    .append("g").attr("transform",`translate(${ml},${mt})`);

  // clip path — keeps founding curve inside chart bounds
  svg.append("defs").append("clipPath").attr("id","sbe-clip")
    .append("rect").attr("width", bw).attr("height", bh);

  // viable zone
  svg.append("rect").attr("x",x(40)).attr("width",x(85)-x(40)).attr("y",0).attr("height",bh).attr("fill","rgba(76,175,80,0.08)");
  svg.append("text").attr("x",(x(40)+x(85))/2).attr("y",12).attr("text-anchor","middle").attr("fill","#4caf50").attr("font-size","9px").attr("font-weight","700").text("← viable zone →");

  const lf = d3.line().x(d=>x(d.m)).y(d=>y(d.d)).curve(d3.curveCatmullRom);

  // baseline curve (amber, dashed)
  svg.append("path").datum(ptsBase).attr("fill","none").attr("stroke","#f0c040")
    .attr("stroke-width",1.5).attr("stroke-dasharray","5,4").attr("opacity",0.6).attr("d",lf);
  svg.append("text").attr("x",x(30)).attr("y",y(burdenBase/30)+12)
    .attr("fill","#a08030").attr("font-size","9px").text("baseline");

  // automated curve (green, solid, animated)
  const pa = svg.append("path").datum(ptsAuto).attr("fill","none").attr("stroke","#4caf50")
    .attr("stroke-width",2.5).attr("d",lf);
  const ln = pa.node().getTotalLength();
  pa.attr("stroke-dasharray",ln).attr("stroke-dashoffset",ln)
    .transition().duration(900).attr("stroke-dashoffset",0);
  svg.append("text").attr("x",x(30)).attr("y",y(burdenAuto/30)+12)
    .attr("fill","#4caf50").attr("font-size","9px").attr("font-weight","700").text("automated");

  // founding mix curve (blue, dashed, clipped)
  const lfDef = d3.line().defined(d => y(d.d) >= 0 && y(d.d) <= bh)
    .x(d=>x(d.m)).y(d=>y(d.d)).curve(d3.curveCatmullRom);
  const pf = svg.append("path").datum(ptsFnd).attr("fill","none").attr("stroke","#7ab5d8")
    .attr("stroke-width",2).attr("stroke-dasharray","6,3")
    .attr("clip-path","url(#sbe-clip)").attr("d",lfDef);
  const lnF = pf.node().getTotalLength();
  pf.attr("stroke-dashoffset",lnF).transition().delay(300).duration(900).attr("stroke-dashoffset",0);
  // label near a mid-curve point that's within chart bounds
  const lblFndM = 80;
  svg.append("text").attr("x",x(lblFndM)).attr("y",y(burdenRemain/(lblFndM-foundingN))-7)
    .attr("fill","#7ab5d8").attr("font-size","9px").attr("font-weight","700").text("founding mix");

  // founding break-even intercept dot + label at ~46 members
  svg.append("line").attr("x1",x(mFoundBreak)).attr("x2",x(mFoundBreak))
    .attr("y1",y(regDues)).attr("y2",bh).attr("stroke","#4a80a8").attr("stroke-dasharray","3,3");
  svg.append("circle").attr("cx",x(mFoundBreak)).attr("cy",y(regDues)).attr("r",3.5).attr("fill","#7ab5d8");
  svg.append("text").attr("x",x(mFoundBreak)+5).attr("y",y(regDues)-7)
    .attr("fill","#7ab5d8").attr("font-size","9px").attr("font-weight","700")
    .text(`~${Math.round(mFoundBreak)} total`);

  // automated & baseline vertical intercepts @ avg dues
  const ma6 = burdenAuto / regDues, mb6 = burdenBase / regDues;
  svg.append("line").attr("x1",x(mb6)).attr("x2",x(mb6)).attr("y1",y(regDues)).attr("y2",bh)
    .attr("stroke","#5a4020").attr("stroke-dasharray","3,3");
  svg.append("line").attr("x1",x(ma6)).attr("x2",x(ma6)).attr("y1",y(regDues)).attr("y2",bh)
    .attr("stroke","#2a5030").attr("stroke-dasharray","3,3");

  // automation savings arrow
  const arrowY = y(regDues) - 28;
  svg.append("line").attr("x1",x(ma6)+2).attr("x2",x(mb6)-2).attr("y1",arrowY).attr("y2",arrowY)
    .attr("stroke","#f0c040").attr("stroke-width",1.5);
  svg.append("text").attr("x",(x(ma6)+x(mb6))/2).attr("y",arrowY-4)
    .attr("text-anchor","middle").attr("fill","#f0c040").attr("font-size","9px").attr("font-weight","700")
    .text(`−${Math.round(mb6-ma6)} members`);

  svg.append("g").attr("transform",`translate(0,${bh})`).call(d3.axisBottom(x).ticks(7))
    .selectAll("text").attr("fill","#5a7a94").attr("font-size","10px");
  svg.append("text").attr("x",bw/2).attr("y",bh+28).attr("text-anchor","middle")
    .attr("fill","#5a7a94").attr("font-size","10px").text("Members");
  svg.append("g").call(d3.axisLeft(y).ticks(5).tickFormat(d=>"$"+Math.round(d/1000)+"K"))
    .selectAll("text").attr("fill","#5a7a94").attr("font-size","10px");
  svg.selectAll(".domain,.tick line").attr("stroke","#1e3048");
}

/* ── Slide 10: Capital Required ── */
function slideCapital(c) {
  const M = MODEL;
  const k = n => Math.round(n / 1000);
  const surplus = M.shareEquity - M.dealTotal;
  const grid = sWrap("sstat-grid");
  [{v:`$${k(M.askPrice).toLocaleString()}K`,                       k:"Acquisition price [G]",                       cls:""     },
   {v:`$${k(M.renovation)}K`,                                      k:"Renovation mid-estimate [E]",                 cls:""     },
   {v:`$${k(M.carry)}K`,                                           k:"Pre-revenue carry costs [E]",                 cls:""     },
   {v:`$${(M.dealTotal/1e6).toFixed(3).replace(/\.?0+$/,"")}M`,   k:"Total capital required",                      cls:"s-warn"},
   {v:`$${(M.shareEquity/1e6).toFixed(2)}M`,                       k:`Share equity — ${M.totalMembers} shares [G]`, cls:"s-ok" },
   {v:`+$${k(surplus)}K`,                                          k:"Surplus cushion above deal cost",             cls:"s-ok" }]
  .forEach(s => { const d=sEl("div","sstat "+s.cls); d.innerHTML=`<div class="sv">${s.v}</div><div class="sk">${s.k}</div>`; grid.appendChild(d); });
  c.appendChild(grid);
  const cw = sWrap("schart-wrap");
  cw.appendChild(sEl("div","schart-title","Deal cost components — share equity covers all three [G/E]"));
  const cd = sEl("div"); cd.id="scp-chart"; cw.appendChild(cd);
  cw.appendChild(sNote("[G] Acquisition price per MLS listing. [E] Renovation: $250–500K range, mid $375K (inspection required — OI-04). Carry: debt service + tax + utilities + insurance + misc over ~15 months."));
  c.appendChild(cw);
  const comps = [
    { label:"Acquisition",    val: M.askPrice,   color:"#f0c040" },
    { label:"Renovation [E]", val: M.renovation, color:"#7ab5d8" },
    { label:"Carry [E]",      val: M.carry,      color:"#e07840" },
  ];
  const total = M.dealTotal;
  const W=sVizW(), H=155, ml=145, mr=120, mt=8, mb=8;
  const bw=W-ml-mr, bh=H-mt-mb;
  const x=d3.scaleLinear().domain([0,total*1.1]).range([0,bw]);
  const y=d3.scaleBand().domain(comps.map(d=>d.label)).range([0,bh]).padding(0.35);
  const svg=d3.select("#scp-chart").append("svg").attr("width",W).attr("height",H)
    .append("g").attr("transform",`translate(${ml},${mt})`);
  svg.selectAll("rect").data(comps).join("rect")
    .attr("y",d=>y(d.label)).attr("height",y.bandwidth())
    .attr("x",0).attr("width",0).attr("rx",4)
    .attr("fill",d=>d.color).attr("opacity",0.85)
    .transition().duration(600).delay((_,i)=>i*120).attr("width",d=>x(d.val));
  svg.selectAll(".lbl").data(comps).join("text").attr("class","lbl")
    .attr("x",-6).attr("y",d=>y(d.label)+y.bandwidth()/2+4)
    .attr("text-anchor","end").attr("fill","#7090a8").attr("font-size","12px").text(d=>d.label);
  svg.selectAll(".vv").data(comps).join("text").attr("class","vv")
    .attr("x",d=>x(d.val)+7).attr("y",d=>y(d.label)+y.bandwidth()/2+4)
    .attr("fill",d=>d.color).attr("font-size","12px").attr("font-weight","700")
    .text(d=>"$"+(d.val/1000).toFixed(0)+"K");
  svg.append("line").attr("x1",x(total)).attr("x2",x(total)).attr("y1",-5).attr("y2",bh+5)
    .attr("stroke","#f0c040").attr("stroke-dasharray","4,3").attr("stroke-width",1.5);
  svg.append("text").attr("x",x(total)+6).attr("y",bh/2+4)
    .attr("fill","#f0c040").attr("font-size","12px").attr("font-weight","700")
    .text("Total: $"+(total/1000).toFixed(0)+"K");
  c.appendChild(sEl("div","srisk",
    `<span class="sbold">Bottom line:</span> ${M.totalMembers} shares at $${M.tiers[0].sharePx.toLocaleString()}\u2013$${M.tiers[1].sharePx.toLocaleString()} raise $${(M.shareEquity/1e6).toFixed(2)}M against a $${(M.dealTotal/1e6).toFixed(3).replace(/\.?0+$/,"")}M deal \u2014 no mortgage required. If the club fails, a penclave-discounted exit at ~$800K against $${k(M.askPrice)}K paid + $${k(M.renovation)}K renovation = <span class="sbold">~$${k(M.shareEquity - 800000)}K collective member loss [E]</span>. That is the downside you are accepting.`));
}

/* ── Slide 11: Go / No-Go ── */
function slideGoNoGo(c) {
  const M = MODEL;
  const k = n => Math.round(n / 1000);
  c.appendChild(sEl("div","schart-title","Rule 5 failure list — conditions that make the deal unworkable"));
  const cw = sWrap("schart-wrap");
  const tbl = sEl("table","gono-tbl");
  tbl.innerHTML = `
    <thead><tr><th>Condition</th><th>Threshold</th><th>Signal</th><th>Status</th></tr></thead>
    <tbody>
      <tr><td class="cond-col">Liquor license transfer</td><td class="thresh-col">WSLCB denies Class 6 Club License application</td><td><span class="signal-stop">DEAL STOP</span></td><td class="thresh-col">Open — OI-02</td></tr>
      <tr><td class="cond-col">Renovation cost</td><td class="thresh-col">Actual cost &gt; $600K after inspection</td><td><span class="signal-stop">DEAL STOP</span></td><td class="thresh-col">Open — OI-04</td></tr>
      <tr><td class="cond-col">Founding membership</td><td class="thresh-col">&lt; 50 Founding shares ($${M.tiers[0].sharePx.toLocaleString()} each) committed before close</td><td><span class="signal-stop">DEAL STOP</span></td><td class="thresh-col">Not tested</td></tr>
      <tr><td class="cond-col">Canadian demand &lt;40%</td><td class="thresh-col">Tariff / political climate locks in \u221230% Canadian visitor loss</td><td><span class="signal-warn">RESTRUCTURE</span></td><td class="thresh-col">Active (2025)</td></tr>
      <tr><td class="cond-col">Border closure scenario</td><td class="thresh-col">Revenue \u2192 ~$0 for 17+ months (documented 2020\u20132021)</td><td><span class="signal-stop">STOP</span> w/o reserve</td><td class="thresh-col">Needs $700K\u2013$1M reserve</td></tr>
    </tbody>`;
  cw.appendChild(tbl); c.appendChild(cw);
  c.appendChild(sEl("div","shighlight",
    '<span class="sbold">Gate items before any model is trusted:</span> OI-02 (license class), OI-04 (building inspection). These are not optional — the model inputs are wrong without them.'));
  c.appendChild(sEl("div","srisk",
    `<span class="sbold">Maximum downside in a failed scenario:</span> Exit at penclave-discounted floor (~$800K) vs. $${k(M.askPrice)}K paid + $${k(M.renovation)}K renovation = <span class="sbold">~$${k(M.shareEquity - 800000)}K collective member loss [E]</span> (no mortgage \u2014 members own the asset outright). This is what you are accepting.`));
}

/* ─────────────────────────────────────────────────────────
   URL STATE — shareable links via #hash
───────────────────────────────────────────────────────── */
let _suppressHash = false;

function pushState() {
  if (_suppressHash) return;
  const tab = document.querySelector(".tab-panel.active")?.id || "map-panel";
  const p = new URLSearchParams();
  p.set("tab", tab);
  if (tab === "map-panel") {
    const c = map_.getCenter();
    p.set("zoom", map_.getZoom());
    p.set("lat",  c.lat.toFixed(5));
    p.set("lng",  c.lng.toFixed(5));
  } else if (tab === "presentation-panel") {
    p.set("slide", currentSlide);
  }
  history.replaceState(null, "", "#" + p.toString());
}

function restoreState() {
  const hash = location.hash.slice(1);
  if (!hash) return;
  const p = new URLSearchParams(hash);
  const tab = p.get("tab") || "map-panel";
  _suppressHash = true;
  switchTab(tab);
  if (tab === "map-panel") {
    const zoom = parseFloat(p.get("zoom"));
    const lat  = parseFloat(p.get("lat"));
    const lng  = parseFloat(p.get("lng"));
    if (!isNaN(zoom) && !isNaN(lat) && !isNaN(lng)) {
      map_.setView([lat, lng], zoom, { animate: false });
    }
  } else if (tab === "presentation-panel") {
    const slide = parseInt(p.get("slide"), 10);
    if (!isNaN(slide) && slide >= 0 && slide < SLIDES.length) goToSlide(slide);
  }
  _suppressHash = false;
  pushState(); // normalize (e.g. fill in zoom/lat/lng if missing)
}

window.addEventListener("hashchange", restoreState);

document.getElementById("copy-link-btn").addEventListener("click", () => {
  pushState(); // ensure hash is fresh
  navigator.clipboard.writeText(location.href).then(() => {
    const btn = document.getElementById("copy-link-btn");
    btn.classList.add("copied");
    btn.title = "Copied!";
    setTimeout(() => { btn.classList.remove("copied"); btn.title = "Copy shareable link"; }, 2500);
  }).catch(() => {
    // Fallback for http contexts without clipboard API
    const ta = document.createElement("textarea");
    ta.value = location.href; ta.style.position = "fixed"; ta.style.opacity = "0";
    document.body.appendChild(ta); ta.select(); document.execCommand("copy");
    document.body.removeChild(ta);
    const btn = document.getElementById("copy-link-btn");
    btn.classList.add("copied"); btn.title = "Copied!";
    setTimeout(() => { btn.classList.remove("copied"); btn.title = "Copy shareable link"; }, 2500);
  });
});

/* ─────────────────────────────────────────────────────────
   SEARCH
───────────────────────────────────────────────────────── */
document.getElementById("search-box").addEventListener("input", e => {
  searchQuery = e.target.value.trim();
  renderAll();
});
</script>
</body>
</html>
